var mingo=(()=>{var Xr=Object.defineProperty;var ro=Object.getOwnPropertyDescriptor;var eo=Object.getOwnPropertyNames;var no=Object.prototype.hasOwnProperty;var lt=(t,r)=>{for(var n in r)Xr(t,n,{get:r[n],enumerable:!0})},oo=(t,r,n,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of eo(r))!no.call(t,o)&&o!==n&&Xr(t,o,{get:()=>r[o],enumerable:!(e=ro(r,o))||e.enumerable});return t};var so=t=>oo(Xr({},"__esModule",{value:!0}),t);var ca={};lt(ca,{Aggregator:()=>Gr,Context:()=>tt,ProcessingMode:()=>wt,Query:()=>Hr,aggregate:()=>ma,createUpdater:()=>Zn,find:()=>ua,update:()=>aa});var Dt=class extends Error{},Gt=Symbol("missing"),Ze="mingo: cycle detected while processing object/array",Xt=t=>{let r=vt(t),n=0,e=r.length;for(;e;)n=(n<<5)-n^r.charCodeAt(--e);return n>>>0},Ct=t=>typeof t!="object"&&typeof t!="function"||t===null,tn=t=>Ct(t)||S(t)||H(t),rn={undefined:1,null:2,number:3,string:4,symbol:5,object:6,array:7,arraybuffer:8,boolean:9,date:10,regexp:11,function:12};function w(t,r){t===Gt&&(t=void 0),r===Gt&&(r=void 0);let n=100,[e,o]=[t,r].map(s=>rn[nn(s)?"arraybuffer":L(s)]??n);return e!==o?e-o:(e===n&&(t=vt(t),r=vt(r)),B(t,r)?0:t<r?-1:1)}var Q=class t extends Map{#t=Xt;#r=new Map;#e=r=>{let n=this.#t(r);return[(this.#r.get(n)||[]).find(e=>B(e,r)),n]};constructor(){super()}static init(r){let n=new t;return r&&(n.#t=r),n}clear(){super.clear(),this.#r.clear()}delete(r){if(Ct(r))return super.delete(r);let[n,e]=this.#e(r);return super.delete(n)?(this.#r.set(e,this.#r.get(e).filter(o=>!B(o,n))),!0):!1}get(r){if(Ct(r))return super.get(r);let[n,e]=this.#e(r);return super.get(n)}has(r){if(Ct(r))return super.has(r);let[n,e]=this.#e(r);return super.has(n)}set(r,n){if(Ct(r))return super.set(r,n);let[e,o]=this.#e(r);if(super.has(e))super.set(e,n);else{super.set(r,n);let s=this.#r.get(o)||[];s.push(r),this.#r.set(o,s)}return this}get size(){return super.size}};function m(t,r){if(!t)throw new Dt(r)}function L(t){if(t===null)return"null";let r=typeof t;if(r!=="object"&&r in rn)return r;if(y(t))return"array";if(S(t))return"date";if(H(t))return"regexp";let n=Object.prototype.toString.call(t);return n==="[object Object]"?t?.constructor?.name?.toLowerCase()??"object":n.substring(8,n.length-1).toLowerCase()}var ft=t=>typeof t=="boolean",h=t=>typeof t=="string",io=t=>typeof t=="symbol",b=t=>!isNaN(t)&&typeof t=="number",y=Array.isArray,j=t=>L(t)==="object",en=t=>!Ct(t),S=t=>t instanceof Date,H=t=>t instanceof RegExp,Zt=t=>typeof t=="function",l=t=>t==null,K=(t,r=!0)=>!!t||r&&t==="",Y=t=>l(t)||h(t)&&!t||y(t)&&t.length===0||j(t)&&Object.keys(t).length===0,et=t=>y(t)?t:[t],M=(t,r)=>!!t&&Object.prototype.hasOwnProperty.call(t,r),nn=t=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(t),G=(t,r)=>{if(l(t)||ft(t)||b(t)||h(t))return t;if(S(t))return new Date(t);if(H(t))return new RegExp(t);if(nn(t)){let n=t.constructor;return new n(t)}if(r instanceof Set||(r=new Set),r.has(t))throw new Error(Ze);r.add(t);try{if(y(t)){let n=new Array(t.length);for(let e=0;e<t.length;e++)n[e]=G(t[e],r);return n}if(j(t)){let n={};for(let e of Object.keys(t))n[e]=G(t[e],r);return n}}finally{r.delete(t)}return t},Je=t=>t===Gt;function Jt(t,r){if(Je(t)||l(t))return r;if(Je(r)||l(r))return t;let n=L(t);if(n!==L(r))return r;if(y(t)&&y(r))for(let e=0;e<r.length;e++)e<t.length?t[e]=Jt(t[e],r[e]):t.push(r[e]);else if(n==="object")for(let e of Object.keys(r))t[e]=Jt(t[e],r[e]);return t}function Mt(t,r=Xt){let n=[Q.init(r),Q.init(r)];if(t.length===0)return[];if(t.some(e=>e.length===0))return[];if(t.length===1)return[...t];t[t.length-1].forEach(e=>n[0].set(e,!0));for(let e=t.length-2;e>-1;e--){if(t[e].forEach(o=>{n[0].has(o)&&n[1].set(o,!0)}),n[1].size===0)return[];n.reverse(),n[1].clear()}return Array.from(n[0].keys())}function nt(t,r=1){let n=new Array;function e(o,s){for(let i=0,p=o.length;i<p;i++)y(o[i])&&(s>0||s<0)?e(o[i],Math.max(-1,s-1)):n.push(o[i])}return e(t,r),n}function po(t){let r={};for(;t;){for(let n of Object.getOwnPropertyNames(t))n in r||(r[n]=t[n]);t=Object.getPrototypeOf(t)}return r}var on=t=>t!=null&&t.toString!==Object.prototype.toString;function B(t,r){if(t===r||Object.is(t,r))return!0;if(t===null||r===null||typeof t!=typeof r||typeof t!="object")return!1;if(S(t))return S(r)&&+t==+r;if(H(t))return H(r)&&t.toString()===r.toString();let n=L(t);if(n!==L(r))return!1;switch(n){case"array":if(t.length!==r.length)return!1;for(let e=0,o=t.length;e<o;e++)if(!B(t[e],r[e]))return!1;return!0;case"object":{let e=Object.keys(t),o=Object.keys(r);if(e.length!==o.length)return!1;for(let s of e)if(!(s in r&&B(t[s],r[s])))return!1;return!0}default:return on(t)&&t.toString()===r.toString()}}function Pt(t,r=Xt){let n=Q.init(r);return t.forEach(e=>n.set(e,!0)),Array.from(n.keys())}function vt(t,r){if(t===null)return"null";if(t===void 0)return"undefined";if(h(t)||b(t)||ft(t))return JSON.stringify(t);if(S(t))return t.toISOString();if(H(t)||io(t)||Zt(t))return t.toString();if(r instanceof Set||(r=new Set),r.has(t))throw new Error(Ze);try{if(r.add(t),y(t))return"["+t.map(e=>vt(e,r)).join(",")+"]";if(j(t))return"{"+Object.keys(t).sort().map(o=>`${o}:${vt(t[o],r)}`).join()+"}";let n=on(t)?t.toString():vt(po(t),r);return L(t)+"("+n+")"}finally{r.delete(t)}}function tr(t,r){return l(t)?null:(r=r||Xt,r(t))}function Rt(t,r,n=Xt){if(t.length<1)return new Map;let e=Q.init(n);for(let o=0;o<t.length;o++){let s=t[o],i=r(s,o)??null,p=e.get(i);p?p.push(s):(p=[s],e.set(i,p))}return e}function Zr(t,r){return en(t)?t[r]:void 0}function ao(t,r){if(r<1)return t;for(;r--&&t.length===1&&y(t[0]);)t=t[0];return t}function k(t,r,n){let e=0;function o(i,p){let a=i;for(let c=0;c<p.length;c++){let f=p[c];if(/^\d+$/.exec(f)===null&&y(a)){if(c===0&&e>0)break;e+=1;let A=p.slice(c);a=a.reduce((d,x)=>{let g=o(x,A);return g!==void 0&&d.push(g),d},[]);break}else a=Zr(a,f);if(a===void 0)break}return a}let s=tn(t)?t:o(t,r.split("."));return y(s)&&n?.unwrapArray?ao(s,e):s}function bt(t,r,n){let e=r.indexOf("."),o=e==-1?r:r.substring(0,e),s=r.substring(e+1),i=e!=-1;if(y(t)){let c=/^\d+$/.test(o),f=c&&n?.preserveIndex?[...t]:[];if(c){let O=parseInt(o),A=Zr(t,O);i&&(A=bt(A,s,n)),n?.preserveIndex?f[O]=A:f.push(A)}else for(let O of t){let A=bt(O,r,n);n?.preserveMissing?f.push(A??Gt):(A!=null||n?.preserveIndex)&&f.push(A)}return f}let p=n?.preserveKeys?{...t}:{},a=Zr(t,o);if(i&&(a=bt(a,s,n)),a!==void 0)return p[o]=a,p}function yr(t){if(y(t))for(let r=t.length-1;r>=0;r--)t[r]===Gt?t.splice(r,1):yr(t[r]);else if(j(t))for(let r in t)M(t,r)&&yr(t[r])}var Xe=/^\d+$/;function _t(t,r,n,e){let o=r.split("."),s=o[0],i=o.slice(1).join(".");if(o.length===1)(j(t)||y(t)&&Xe.test(s))&&n(t,s);else{e?.buildGraph&&l(t[s])&&(t[s]={});let p=t[s];if(!p)return;let a=!!(o.length>1&&Xe.test(o[1]));y(p)&&e?.descendArray&&!a?p.forEach((c=>_t(c,i,n,e))):_t(p,i,n,e)}}function ht(t,r,n){_t(t,r,((e,o)=>{e[o]=Zt(n)?n(e[o]):n}),{buildGraph:!0})}function It(t,r,n){_t(t,r,((e,o)=>{y(e)?e.splice(parseInt(o),1):j(e)&&delete e[o]}),n)}var J=t=>t&&t[0]==="$"&&/^\$[a-zA-Z0-9_]+$/.test(t);function Or(t){if(tn(t))return H(t)?{$regex:t}:{$eq:t};if(en(t)){if(!Object.keys(t).some(J))return{$eq:t};if(M(t,"$regex")){let r={...t};return r.$regex=new RegExp(t.$regex,t.$options),delete r.$options,r}}return t}function Ut(t,r,n=w){let e=0,o=t.length-1;for(;e<=o;){let s=Math.round(e+(o-e)/2);if(n(r,t[s])<0)o=s-1;else if(n(r,t[s])>0)e=s+1;else return s}return e}var wt=(o=>(o[o.CLONE_OFF=0]="CLONE_OFF",o[o.CLONE_INPUT=1]="CLONE_INPUT",o[o.CLONE_OUTPUT=2]="CLONE_OUTPUT",o[o.CLONE_ALL=3]="CLONE_ALL",o))(wt||{}),I=class t{#t;#r;#e;constructor(r,n,e){this.#t=r,this.#e={},this.update(n,e)}static init(r,n,e){return r instanceof t?new t(r.#t,null,r.#e).update(r.#r??n,e):new t(r,n,e)}update(r,n){return this.#r=r,Object.assign(this.#e,{variables:{...this.#e?.variables,...n?.variables},groupId:n?.groupId??this.#e?.groupId,now:this.#e?.now??n?.now??Date.now()}),this}getOptions(){return Object.freeze({...this.#t,context:tt.from(this.#t.context)})}get root(){return this.#r}get local(){return this.#e}get idKey(){return this.#t.idKey}get collation(){return this.#t?.collation}get processingMode(){return this.#t?.processingMode||0}get useStrictMode(){return this.#t?.useStrictMode}get scriptEnabled(){return this.#t?.scriptEnabled}get useGlobalContext(){return this.#t?.useGlobalContext}get hashFunction(){return this.#t?.hashFunction}get collectionResolver(){return this.#t?.collectionResolver}get jsonSchemaValidator(){return this.#t?.jsonSchemaValidator}get variables(){return this.#t?.variables}get context(){return this.#t?.context}};function yt(t){return t instanceof I?t.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:0,...t,context:tt.from(t?.context??tt.init())})}var Tt=(i=>(i.ACCUMULATOR="accumulator",i.EXPRESSION="expression",i.PIPELINE="pipeline",i.PROJECTION="projection",i.QUERY="query",i.WINDOW="window",i))(Tt||{}),tt=class t{#t=new Map(Object.values(Tt).map(r=>[r,{}]));constructor(){}static init(r={}){let n=new t;for(let[e,o]of Object.entries(r))n.#t.has(e)&&o&&n.addOperators(e,o);return n}static from(r){return t.init(r&&Object.fromEntries(r.#t)||{})}static merge(r,n){let e=t.from(r);for(let o of Object.values(Tt))e.addOperators(o,n.#t.get(o));return e}addOperators(r,n){return this.#t.set(r,Object.assign({},n,this.#t.get(r))),this}getOperator(r,n){return this.#t.get(r)[n]??null}addAccumulatorOps(r){return this.addOperators("accumulator",r)}addExpressionOps(r){return this.addOperators("expression",r)}addQueryOps(r){return this.addOperators("query",r)}addPipelineOps(r){return this.addOperators("pipeline",r)}addProjectionOps(r){return this.addOperators("projection",r)}addWindowOps(r){return this.addOperators("window",r)}},ot=tt.init(),Oa={accumulator:ot.addAccumulatorOps.bind(ot),expression:ot.addExpressionOps.bind(ot),pipeline:ot.addPipelineOps.bind(ot),projection:ot.addProjectionOps.bind(ot),query:ot.addQueryOps.bind(ot),window:ot.addWindowOps.bind(ot)};function st(t,r,n){if(!J(r))return null;let{context:e,useGlobalContext:o}=n||{},s=e?e.getOperator(t,r):null;return!s&&o?ot.getOperator(t,r):s}function u(t,r,n,e){let o=I.init(e,t);return n&&J(n)?sn(t,r,n,o):Ar(t,r,o)}var mo=["$$ROOT","$$CURRENT","$$REMOVE","$$NOW"];function Ar(t,r,n){if(h(r)&&r.length>0&&r[0]==="$"){if(uo.includes(r))return r;let e=n.root,o=r.split(".");if(mo.includes(o[0])){switch(o[0]){case"$$ROOT":break;case"$$CURRENT":e=t;break;case"$$REMOVE":e=void 0;break;case"$$NOW":e=new Date(n.local?.now);break}r=r.slice(o[0].length+1)}else if(o[0].slice(0,2)==="$$"){e=Object.assign({},n.variables,{this:t},n?.local?.variables);let s=o[0].slice(2);m(M(e,s),`Use of undefined variable: ${s}`),r=r.slice(2)}else r=r.slice(1);return r===""?e:k(e,r)}if(y(r))return r.map(e=>Ar(t,e,n));if(j(r)){let e={},o=Object.entries(r);for(let[s,i]of o){if(J(s))return m(o.length==1,"expression must have single operator."),sn(t,i,s,n);e[s]=Ar(t,i,n)}return e}return r}function sn(t,r,n,e){let o=st("expression",n,e);if(o)return o(t,r,e);let s=st("accumulator",n,e);return m(!!s,`accumulator '${n}' is not registered.`),y(t)||(t=Ar(t,r,e),r=null),m(y(t),`arguments must resolve to array for ${n}.`),s(t,r,e)}var uo=["$$KEEP","$$PRUNE","$$DESCEND"];function br(t,r,n){let e=u(t,r,null,n);switch(e){case"$$KEEP":return t;case"$$PRUNE":return;case"$$DESCEND":{if(!M(r,"$cond"))return t;let o={};for(let[s,i]of Object.entries(t))if(y(i)){let p=new Array;for(let a of i)j(a)&&(a=br(a,r,n.update(a))),l(a)||p.push(a);o[s]=p}else if(j(i)){let p=br(i,r,n.update(i));l(p)||(o[s]=p)}else o[s]=i;return o}default:return e}}function N(t){return t instanceof Ft?t:new Ft(t)}function dt(...t){let r=0;return N(()=>{for(;r<t.length;){let n=t[r].next();if(!n.done)return n;r++}return{done:!0}})}function co(t){return!!t&&typeof t=="object"&&typeof t?.next=="function"}function lo(t){return!!t&&(typeof t=="object"||typeof t=="function")&&typeof t[Symbol.iterator]=="function"}var Ft=class{#t=[];#r=[];#e;#o=!1;constructor(r){let n=lo(r)?r[Symbol.iterator]():co(r)?r:typeof r=="function"?{next:r}:null;m(!!n,"Iterator must be initialized with an iterable or function.");let e=-1,o={done:!1};this.#e=()=>{for(;!o.done&&(o=n.next(),!o.done);){let s=o.value;if(e++,this.#t.every(({op:p,fn:a})=>{let c=a(s,e);return p==="map"?!!(s=c)||!0:c}))return{value:s,done:!1}}return{done:!0}}}push(r,n){return this.#t.push({op:r,fn:n}),this}next(){return this.#e()}map(r){return this.push("map",r)}filter(r){return this.push("filter",r)}take(r){return r>0?this.filter(n=>!(r===0||r--===0)):this}drop(r){return r>0?this.filter(n=>r===0||r--===0):this}transform(r){let n=this,e;return N(()=>(e||(e=N(r(n.value()))),e.next()))}value(){for(;!this.#o;){let{done:r,value:n}=this.#e();r||this.#r.push(n),this.#o=r}return this.#r}each(r){for(;;){let n=this.next();if(n.done)break;if(r(n.value)===!1)return!1}return!0}reduce(r,n){let e=this.next();for(n===void 0&&!e.done&&(n=e.value,e=this.next());!e.done;)n=r(n,e.value),e=this.next();return n}size(){return this.reduce(((r,n)=>++r),0)}[Symbol.iterator](){return this}};var pt=class{#t;#r;constructor(r,n){this.#t=r,this.#r=n}stream(r,n){let e=N(r),o=n??this.#r,s=o.processingMode;return s&1&&e.map(G),e=this.#t.map((i,p)=>{let a=Object.keys(i);m(a.length===1,`aggregation stage must have single operator, got ${a.toString()}.`);let c=a[0];m(c!=="$documents"||p==0,"$documents must be first stage in pipeline.");let f=st("pipeline",c,o);return m(!!f,`unregistered pipeline operator ${c}.`),[f,i[c]]}).reduce((i,[p,a])=>p(i,a,o),e),s&2&&e.map(G),e}run(r,n){return this.stream(r,n).value()}};var ie={};lt(ie,{$accumulator:()=>fo,$addToSet:()=>yo,$avg:()=>Oo,$bottom:()=>xo,$bottomN:()=>te,$count:()=>go,$covariancePop:()=>ho,$covarianceSamp:()=>jo,$first:()=>re,$firstN:()=>gr,$last:()=>ee,$lastN:()=>hr,$max:()=>Eo,$maxN:()=>jr,$median:()=>ne,$mergeObjects:()=>oe,$min:()=>$o,$minN:()=>Er,$percentile:()=>rr,$push:()=>$,$stdDevPop:()=>Io,$stdDevSamp:()=>To,$sum:()=>wo,$top:()=>No,$topN:()=>se});var fo=(t,r,n)=>{if(m(!!n&&n.scriptEnabled,"$accumulator operator requires 'scriptEnabled' option to be true"),t.length==0)return r.initArgs;let e=I.init(n),o=u({},r.initArgs||[],null,e.update(e?.local?.groupId||{})),s=r.init.call(null,...o);for(let i of t){let p=u(i,r.accumulateArgs,null,e.update(i));s=r.accumulate.call(null,s,...p)}return r.finalize?r.finalize.call(null,s):s};var $=(t,r,n)=>{if(l(r))return t;let e=I.init(n);return t.map(o=>u(o,r,null,e.update(o)))};var yo=(t,r,n)=>Pt($(t,r,n),n?.hashFunction);var Oo=(t,r,n)=>{let e=$(t,r,n).filter(b);return e.reduce((s,i)=>s+i,0)/(e.length||1)};var Z=(t,r,n)=>{if(Y(r)||!j(r))return t;let e=w,o=n.collation;return j(o)&&h(o.locale)&&(e=bo(o)),t.transform(s=>{let i=Object.keys(r);for(let p of i.reverse()){let a=Rt(s,O=>k(O,p),n.hashFunction),c=Array.from(a.keys()).sort(e);r[p]===-1&&c.reverse();let f=0;for(let O of c)for(let A of a.get(O))s[f++]=A;m(f==s.length,"bug: counter must match collection size.")}return s})},Ao={1:"base",2:"accent",3:"variant"};function bo(t){let r={sensitivity:Ao[t.strength||3],caseFirst:t.caseFirst==="off"?"false":t.caseFirst||"false",numeric:t.numericOrdering||!1,ignorePunctuation:t.alternate==="shifted"};t.caseLevel===!0&&(r.sensitivity==="base"&&(r.sensitivity="case"),r.sensitivity==="accent"&&(r.sensitivity="variant"));let n=new Intl.Collator(t.locale,r);return(e,o)=>{if(!h(e)||!h(o))return w(e,o);let s=n.compare(e,o);return s<0?-1:s>0?1:0}}var te=(t,r,n)=>{let e=I.init(n),o=u(e.local.groupId,r.n,null,e),s=Z(N(t),r.sortBy,n).value(),i=s.length;return $(i<=o?s:s.slice(i-o),r.output,e)};var xo=(t,r,n)=>te(t,{...r,n:1},n);var go=(t,r,n)=>t.length;function dr(t,r=!0){let n=t.reduce((s,i)=>s+i,0),e=t.length||1,o=n/e;return Math.sqrt(t.reduce((s,i)=>s+Math.pow(i-o,2),0)/(e-Number(r)))}function xr(t,r=!0){if(!t)return null;if(t.length<2)return r?null:0;let n=0,e=0;for(let[s,i]of t)n+=s,e+=i;n/=t.length,e/=t.length;let o=0;for(let[s,i]of t)o+=(s-n)*(i-e);return o/(t.length-Number(r))}var ho=(t,r,n)=>xr($(t,r,n),!1);var jo=(t,r,n)=>xr($(t,r,n),!0);var re=(t,r,n)=>{if(t.length===0)return;let e=I.init(n).update(t[0]);return u(t[0],r,null,e)};var gr=(t,r,n)=>{let e=I.init(n),o=t.length,s=u(e?.local?.groupId,r.n,null,e);return m(s>0,"$firstN: 'n' must resolve to a positive integer."),$(o<=s?t:t.slice(0,s),r.input,n)};var ee=(t,r,n)=>{if(t.length===0)return;let e=t[t.length-1],o=I.init(n).update(e);return u(e,r,null,o)};var hr=(t,r,n)=>{let e=I.init(n),o=t.length,s=u(e?.local?.groupId,r.n,null,e);return $(o<=s?t:t.slice(o-s),r.input,n)};var Eo=(t,r,n)=>{let e=$(t,r,n);if(Y(e))return null;m(y(e),"$max: input must resolve to array");let o=e[0];for(let s of e)l(s)||isNaN(s)||w(s,o)>=0&&(o=s);return o};var jr=(t,r,n)=>{let e=I.init(n),o=t.length,s=u(e?.local?.groupId,r.n,null,e),i=$(t,r.input,n).filter(p=>!l(p));return i.sort((p,a)=>-1*w(p,a)),o<=s?i:i.slice(0,s)};var rr=(t,r,n)=>{let e=$(t,r.input,n).filter(b).sort(),o=$(r.p,"$$CURRENT",n).filter(b),s=r.method||"approximate";return o.map(i=>{m(i>0&&i<=1,`percentile value must be between 0 (exclusive) and 1 (inclusive): invalid '${i}'.`);let p=i*(e.length-1)+1,a=Math.floor(p),c=p===a?e[p-1]:e[a-1]+p%1*(e[a]-e[a-1]||0);switch(s){case"exact":return c;case"approximate":{let f=Ut(e,c);return f/e.length>=i?e[Math.max(f-1,0)]:e[f]}}})};var ne=(t,r,n)=>rr(t,{...r,p:[.5]},n).pop();var oe=(t,r,n)=>{let e={};for(let o of t)if(!l(o))for(let s of Object.keys(o))o[s]!==void 0&&(e[s]=o[s]);return e};var $o=(t,r,n)=>{let e=$(t,r,n);if(Y(e))return null;m(y(e),"$min: input must resolve to array");let o=e[0];for(let s of e)l(s)||isNaN(s)||w(s,o)<=0&&(o=s);return o};var Er=(t,r,n)=>{let e=I.init(n),o=t.length,s=u(e?.local?.groupId,r.n,null,e),i=$(t,r.input,n).filter(p=>!l(p));return i.sort(w),o<=s?i:i.slice(0,s)};var Io=(t,r,n)=>dr($(t,r,n).filter(b),!1);var To=(t,r,n)=>dr($(t,r,n).filter(b),!0);var wo=(t,r,n)=>y(t)?b(r)?t.length*r:$(t,r,n).filter(b).reduce((o,s)=>o+s,0):0;var se=(t,r,n)=>{let e=I.init(n),{n:o,sortBy:s}=u(e.local.groupId,r,null,e),i=Z(N(t),s,n).take(o).value();return $(i,r.output,e)};var No=(t,r,n)=>se(t,{...r,n:1},n);var Pe={};lt(Pe,{$abs:()=>ko,$acos:()=>Ni,$acosh:()=>ki,$add:()=>So,$allElementsTrue:()=>Xs,$and:()=>An,$anyElementTrue:()=>Zs,$arrayElemAt:()=>Qo,$arrayToObject:()=>Ko,$asin:()=>Si,$asinh:()=>Ci,$atan:()=>vi,$atan2:()=>Di,$atanh:()=>_i,$bitAnd:()=>As,$bitNot:()=>bs,$bitOr:()=>ds,$bitXor:()=>xs,$ceil:()=>Co,$cmp:()=>xn,$concat:()=>si,$concatArrays:()=>qo,$cond:()=>gs,$convert:()=>Qi,$cos:()=>Mi,$cosh:()=>Pi,$dateAdd:()=>Nt,$dateDiff:()=>Ns,$dateFromParts:()=>Cs,$dateFromString:()=>Ps,$dateSubtract:()=>Rs,$dateToParts:()=>Us,$dateToString:()=>we,$dateTrunc:()=>Bs,$dayOfMonth:()=>Ae,$dayOfWeek:()=>be,$dayOfYear:()=>de,$degreesToRadians:()=>Ui,$divide:()=>vo,$eq:()=>gn,$exp:()=>Do,$filter:()=>Yo,$first:()=>Ho,$firstN:()=>Go,$floor:()=>_o,$function:()=>fe,$getField:()=>Ks,$gt:()=>hn,$gte:()=>jn,$hour:()=>xe,$ifNull:()=>le,$in:()=>Jo,$indexOfArray:()=>Xo,$indexOfBytes:()=>ii,$isArray:()=>Zo,$isNumber:()=>Ki,$isoDayOfWeek:()=>ge,$isoWeek:()=>he,$isoWeekYear:()=>Ls,$last:()=>ts,$lastN:()=>rs,$let:()=>Hi,$literal:()=>zs,$ln:()=>Mo,$log:()=>Po,$log10:()=>Ro,$lt:()=>En,$lte:()=>$n,$ltrim:()=>ai,$map:()=>es,$maxN:()=>ns,$median:()=>Qs,$mergeObjects:()=>Ne,$millisecond:()=>je,$minN:()=>os,$minute:()=>Ee,$mod:()=>Uo,$month:()=>$e,$multiply:()=>Fo,$ne:()=>In,$nin:()=>ms,$not:()=>bn,$objectToArray:()=>Hs,$or:()=>dn,$percentile:()=>Js,$pow:()=>Vo,$radiansToDegrees:()=>Vi,$rand:()=>qs,$range:()=>us,$reduce:()=>cs,$regexFind:()=>mi,$regexFindAll:()=>ui,$regexMatch:()=>ci,$replaceAll:()=>li,$replaceOne:()=>fi,$reverseArray:()=>ls,$round:()=>Wo,$rtrim:()=>yi,$sampleRate:()=>Ys,$second:()=>Ie,$setDifference:()=>ti,$setEquals:()=>ri,$setField:()=>ke,$setIntersection:()=>ei,$setIsSubset:()=>ni,$setUnion:()=>oi,$sin:()=>Wi,$sinh:()=>Bi,$size:()=>fs,$slice:()=>ce,$sortArray:()=>ys,$split:()=>Oi,$sqrt:()=>Bo,$strLenBytes:()=>bi,$strLenCP:()=>di,$strcasecmp:()=>Ai,$substr:()=>Se,$substrBytes:()=>ji,$substrCP:()=>Ei,$subtract:()=>Lo,$switch:()=>hs,$tan:()=>Li,$tanh:()=>zi,$toBool:()=>Ce,$toDate:()=>ve,$toDecimal:()=>qi,$toDouble:()=>ar,$toHashedIndexKey:()=>wi,$toInt:()=>De,$toLong:()=>_e,$toLower:()=>$i,$toString:()=>Me,$toUpper:()=>Ii,$trim:()=>Ti,$trunc:()=>zo,$type:()=>Yi,$unsetField:()=>Gs,$week:()=>Te,$year:()=>Br,$zip:()=>Os});var ko=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:Math.abs(e)};var So=(t,r,n)=>{let e=u(t,r,null,n),o=!1,s=0;for(let i of e)S(i)&&(m(!o,"'$add' can only have one date value"),o=!0),s+=+i;return o?new Date(s):s};var Co=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(b(e)||isNaN(e),"$ceil expression must resolve to a number."),Math.ceil(e))};var vo=(t,r,n)=>{let e=u(t,r,null,n);return e[0]/e[1]};var Do=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(b(e)||isNaN(e),"$exp expression must resolve to a number."),Math.exp(e))};var _o=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(b(e)||isNaN(e),"$floor expression must resolve to a number."),Math.floor(e))};var Mo=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(b(e)||isNaN(e),"$ln expression must resolve to a number."),Math.log(e))};var Po=(t,r,n)=>{let e=u(t,r,null,n),o="$log expression must resolve to array(2) of numbers";return m(y(e)&&e.length===2,o),e.some(l)?null:(m(e.some(isNaN)||e.every(b),o),Math.log10(e[0])/Math.log10(e[1]))};var Ro=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(b(e)||isNaN(e),"$log10 expression must resolve to a number."),Math.log10(e))};var Uo=(t,r,n)=>{let e=u(t,r,null,n);return e[0]%e[1]};var Fo=(t,r,n)=>u(t,r,null,n).reduce((o,s)=>o*s,1);var Vo=(t,r,n)=>{let e=u(t,r,null,n);return m(y(e)&&e.length===2&&e.every(b),"$pow expression must resolve to array(2) of numbers"),m(!(e[0]===0&&e[1]<0),"$pow cannot raise 0 to a negative exponent"),Math.pow(e[0],e[1])};function $r(t,r=0,n=!1){let e=Math.abs(t)===t?1:-1;t=Math.abs(t);let o=Math.trunc(t),s=parseFloat((t-o).toFixed(Math.abs(r)+1));if(r===0){let i=Math.trunc(10*s);n&&((o&1)===1&&i>=5||i>5)&&o++}else if(r>0){let i=Math.pow(10,r),p=Math.trunc(s*i),a=Math.trunc(s*i*10)%10;n&&a>5&&(p+=1),o=(o*i+p)/i}else if(r<0){let i=Math.pow(10,-1*r),p=o%i;if(o=Math.max(0,o-p),n&&e===-1){for(;p>10;)p-=p/10;o>0&&p>=5&&(o+=i)}}return o*e}var Wo=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1];return l(o)||isNaN(o)||Math.abs(o)===1/0?o:(m(b(o),"$round expression must resolve to a number."),$r(o,s,!0))};var Bo=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(b(e)&&e>0||isNaN(e),"$sqrt expression must resolve to non-negative number."),Math.sqrt(e))};var Lo=(t,r,n)=>{let e=u(t,r,null,n),o="$subtract: must resolve to array(2) of numbers/dates";m(y(e)&&e.length===2,o);let s=e.map(L).join("|");return s==="date|number"?new Date(+e[0]-+e[1]):(m(s==="date|date"||s==="number|number",o),+e[0]-+e[1])};var zo=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1];return l(o)||isNaN(o)||Math.abs(o)===1/0?o:(m(b(o),"$trunc expression must resolve to a number."),m(l(s)||b(s)&&s>-20&&s<100,"$trunc expression has invalid place"),$r(o,s,!1))};var Qo=(t,r,n)=>{let e=u(t,r,null,n);if(m(y(e)&&e.length===2,"$arrayElemAt expression must resolve to array(2)"),e.some(l))return null;let o=e[1],s=e[0];if(o<0&&Math.abs(o)<=s.length)return s[(o+s.length)%s.length];if(o>=0&&o<s.length)return s[o]};var Ko=(t,r,n)=>{let e=u(t,r,null,n);return m(y(e),"$arrayToObject: expression must resolve to an array"),e.reduce((o,s)=>{for(;y(s)&&s.length===1;)s=s[0];if(y(s)&&s.length==2)o[s[0]]=s[1];else{let i=s;m(j(i)&&M(i,"k")&&M(i,"v"),"$arrayToObject expression is invalid."),o[i.k]=i.v}return o},{})};var qo=(t,r,n)=>{let e=u(t,r,null,n);m(y(e),"$concatArrays: input must resolve to an array");let o=0;for(let p of e){if(l(p))return null;o+=p.length}let s=new Array(o),i=0;for(let p of e)for(let a of p)s[i++]=a;return s};var Yo=(t,r,n)=>{let e=u(t,r.input,null,n);if(l(e))return null;m(y(e),"$filter 'input' expression must resolve to an array");let o=I.init(n,t),s=r.as||"this",i={variables:{[s]:null}};return e.filter(p=>{i.variables[s]=p;let a=u(t,r.cond,null,o.update(o.root,i));return K(a,n.useStrictMode)})};var Ho=(t,r,n)=>{if(y(t))return re(t,r,n);let e=u(t,r,null,n);return l(e)?null:(m(y(e)&&e.length>0,"$first must resolve to a non-empty array."),nt(e)[0])};var Go=(t,r,n)=>{if(y(t))return gr(t,r,n);let{input:e,n:o}=u(t,r,null,n);return l(e)?null:(m(y(e),"$firstN: 'input' must resolve to an array."),gr(e,{n:o,input:"$$this"},n))};var Jo=(t,r,n)=>{let[e,o]=u(t,r,null,n);return m(y(o),"$in second argument must be an array"),o.some(s=>B(s,e))};var Xo=(t,r,n)=>{let e=u(t,r,null,n);if(l(e))return null;let o=e[0],s=e[1];if(l(o))return null;m(y(o),"$indexOfArray expression must resolve to an array.");let i=e[2]||0,p=e[3];if(l(p)&&(p=o.length),i>p)return-1;m(i>=0&&p>=0,"$indexOfArray expression is invalid"),(i>0||p<o.length)&&(o=o.slice(i,p));let a=-1;return o.some((c,f)=>{let O=B(c,s);return O&&(a=f),O}),a+i};var Zo=(t,r,n)=>{let e=y(r);return m(!e||r.length===1,"$isArray takes exactly 1 argument."),y(u(t,e?r[0]:r,null,n))};var ts=(t,r,n)=>{if(y(t))return ee(t,r,n);let e=u(t,r,null,n);return l(e)?null:(m(y(e)&&e.length>0,"$last must resolve to a non-empty array."),nt(e)[e.length-1])};var rs=(t,r,n)=>{if(y(t))return hr(t,r,n);let{input:e,n:o}=u(t,r,null,n);return l(e)?null:(m(y(e),"Must resolve to an array/null or missing"),hr(e,{n:o,input:"$$this"},n))};var es=(t,r,n)=>{let e=u(t,r.input,null,n);if(l(e))return null;m(y(e),"$map 'input' expression must resolve to an array");let o=I.init(n),s=r.as||"this";return e.map(i=>u(t,r.in,null,o.update(o.root,{variables:{[s]:i}})))};var ns=(t,r,n)=>{if(y(t))return jr(t,r,n);let{input:e,n:o}=u(t,r,null,n);return l(e)?null:(m(y(e),"Must resolve to an array/null or missing"),jr(e,{n:o,input:"$$this"},n))};var os=(t,r,n)=>{if(y(t))return Er(t,r,n);let{input:e,n:o}=u(t,r,null,n);return l(e)?null:(m(y(e),"$minN: 'input' must resolve to an array."),Er(e,{n:o,input:"$$this"},n))};var pe=(t,r,n)=>t.take(r);var er=(t,r,n)=>Y(r)?t:(an(r,n),t.map(pn(r,I.init(n))));function pn(t,r,n=!0){let e=r.idKey,o=Object.keys(t),s=new Array,i=new Array,p={};for(let d of o){let x=t[d];if(b(x)||ft(x))x?i.push(d):s.push(d);else if(y(x))p[d]=g=>x.map(E=>u(g,E,null,r.update(g))??null);else if(j(x)){let g=Object.keys(x),E=g.length==1?g[0]:"",T=st("projection",E,r);T?E==="$slice"&&!et(x[E]).every(b)?p[d]=D=>u(D,x,d,r.update(D)):p[d]=D=>T(D,x[E],d,r.update(D)):J(E)?p[d]=F=>u(F,x[E],E,r):(an(x,r),p[d]=F=>{if(!M(F,d))return u(F,x,null,r);n&&r.update(F);let D=k(F,d),z=pn(x,r,!1);return y(D)?D.map(z):j(D)?z(D):z(F)})}else p[d]=h(x)&&x[0]==="$"?g=>u(g,x,d,r):g=>x}let a=Object.keys(p),c=s.includes(e);if(n&&c&&s.length===1&&!i.length&&!a.length)return d=>{let x={...d};return delete x[e],x};let O=n&&!c&&!i.includes(e),A={preserveMissing:!0};return d=>{let x={};if(s.length&&!i.length){Jt(x,d);for(let g of s)It(x,g,{descendArray:!0})}for(let g of i){let E=bt(d,g,A)??{};Jt(x,E)}i.length&&yr(x);for(let g of a){let E=p[g](d);E===void 0?It(x,g,{descendArray:!0}):ht(x,g,E)}return O&&M(d,e)&&(x[e]=k(d,e)),x}}function an(t,r){let n=!1,e=!1;for(let[o,s]of Object.entries(t))m(!o.startsWith("$"),"Field names may not start with '$'."),m(!o.endsWith(".$"),"Positional projection operator '$' is not supported."),o!==r?.idKey&&(s===0||s===!1?n=!0:(s===1||s===!0)&&(e=!0),m(!(n&&e),"Projection cannot have a mix of inclusion and exclusion."))}var ae=(t,r,n)=>t.drop(r);var ss={$sort:Z,$skip:ae,$limit:pe},Ir=class{#t;#r;#e;#o;#i={};#n=null;#s=[];constructor(r,n,e,o){this.#t=r,this.#r=n,this.#e=e,this.#o=o}fetch(){if(this.#n)return this.#n;this.#n=N(this.#t).filter(this.#r);let r=this.#o.processingMode;r&1&&this.#n.map(G);for(let n of["$sort","$skip","$limit"])M(this.#i,n)&&(this.#n=ss[n](this.#n,this.#i[n],this.#o));return Object.keys(this.#e).length&&(this.#n=er(this.#n,this.#e,this.#o)),r&2&&this.#n.map(G),this.#n}fetchAll(){let r=N([...this.#s]);return this.#s.length=0,dt(r,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(r){return this.#i.$skip=r,this}limit(r){return this.#i.$limit=r,this}sort(r){return this.#i.$sort=r,this}collation(r){return this.#o={...this.#o,collation:r},this}next(){if(this.#s.length>0)return this.#s.pop();let r=this.fetch().next();if(!r.done)return r.value}hasNext(){if(this.#s.length>0)return!0;let r=this.fetch().next();return r.done?!1:(this.#s.push(r.value),!0)}map(r){return this.all().map(r)}forEach(r){this.all().forEach(r)}[Symbol.iterator](){return this.fetchAll()}};var is=/^\$(and|or|nor|expr|jsonSchema)$/,X=class{#t;#r;#e;constructor(r,n){this.#e=G(r),this.#r=n,this.#t=[],this.compile()}compile(){m(j(this.#e),`query criteria must be an object: ${JSON.stringify(this.#e)}`);let r={};for(let[n,e]of Object.entries(this.#e)){if(n==="$where")m(this.#r.scriptEnabled,"$where operator requires 'scriptEnabled' option to be true."),Object.assign(r,{field:n,expr:e});else if(is.test(n))this.processOperator(n,n,e);else{m(!J(n),`unknown top level operator: ${n}`);for(let[o,s]of Object.entries(Or(e)))this.processOperator(n,o,s)}r.field&&this.processOperator(r.field,r.field,r.expr)}}processOperator(r,n,e){let o=st("query",n,this.#r);m(!!o,`unknown query operator ${n}`),this.#t.push(o(r,e,this.#r))}test(r){return this.#t.every(n=>n(r))}find(r,n){return new Ir(r,e=>this.test(e),n||{},this.#r)}};function C(t,r,n,e){let o={unwrapArray:!0},s=Math.max(1,t.split(".").length-1);return i=>{let p=k(i,t,o);return e(p,r,{...n,depth:s})}}function rt(t,r,n,e){let o=u(t,r,null,n);return e(...o)}function nr(t,r,n){return B(t,r)||l(t)&&l(r)?!0:y(t)?t.some(e=>B(e,r))||nt(t,n?.depth).some(e=>B(e,r)):!1}function Tr(t,r,n){return!nr(t,r,n)}function me(t,r,n){return l(t)?r.some(e=>e===null):Mt([et(t),r],n?.hashFunction).length>0}function wr(t,r,n){return!me(t,r,n)}function Nr(t,r,n){return vr(t,r,(e,o)=>w(e,o)<0)}function kr(t,r,n){return vr(t,r,(e,o)=>w(e,o)<=0)}function Sr(t,r,n){return vr(t,r,(e,o)=>w(e,o)>0)}function Cr(t,r,n){return vr(t,r,(e,o)=>w(e,o)>=0)}function cn(t,r,n){return et(t).some((e=>r.length===2&&e%r[0]===r[1]))}function ln(t,r,n){let e=et(t),o=s=>h(s)&&K(r.exec(s),n?.useStrictMode);return e.some(o)||nt(e,1).some(o)}function fn(t,r,n){if(!y(t)||!y(r)||!t.length||!r.length)return!1;let e=!0;for(let o of r){if(!e)break;j(o)&&Object.keys(o).includes("$elemMatch")?e=ue(t,o.$elemMatch,n):H(o)?e=t.some(s=>typeof s=="string"&&o.test(s)):e=t.some(s=>B(o,s))}return e}function yn(t,r,n){return Array.isArray(t)&&t.length===r}function ps(t){return J(t)&&["$and","$or","$nor"].indexOf(t)===-1}function ue(t,r,n){if(y(t)&&!Y(t)){let e=i=>i,o=r;Object.keys(r).every(ps)&&(o={temp:r},e=i=>({temp:i}));let s=new X(o,n);for(let i=0,p=t.length;i<p;i++)if(s.test(e(t[i])))return!0}return!1}var mn=t=>t===null,as={array:y,boolean:ft,bool:ft,date:S,number:b,int:b,long:b,double:b,decimal:b,null:mn,object:j,regexp:H,regex:H,string:h,undefined:l,1:b,2:h,3:j,4:y,6:l,8:ft,9:S,10:mn,11:H,16:b,18:b,19:b};function un(t,r,n){let e=as[r];return e?e(t):!1}function On(t,r,n){return y(r)?r.findIndex(e=>un(t,e,n))>=0:un(t,r,n)}function vr(t,r,n){return et(t).some(e=>L(e)===L(r)&&n(e,r))}var ms=(t,r,n)=>rt(t,r,n,wr);var us=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1],i=e[2]||1,p=new Array,a=o;for(;a<s&&i>0||a>s&&i<0;)p.push(a),a+=i;return p};var cs=(t,r,n)=>{let e=I.init(n),o=u(t,r.input,null,e),s=u(t,r.initialValue,null,e),i=r.in;return l(o)?null:(m(y(o),"$reduce 'input' expression must resolve to an array"),o.reduce((p,a)=>u(a,i,null,e.update(e.root,{variables:{value:p}})),s))};var ls=(t,r,n)=>{let e=u(t,r,null,n);if(l(e))return null;m(y(e),"$reverseArray expression must resolve to an array");let o=e.slice(0);return o.reverse(),o};var fs=(t,r,n)=>{let e=u(t,r,null,n);return y(e)?e.length:void 0};var ce=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1],i=e[2];return l(i)?s<0?s=Math.max(0,o.length+s):(i=s,s=0):(s<0&&(s=Math.max(0,o.length+s)),m(i>0,"Invalid argument for $slice operator. Limit must be a positive number"),i+=s),o.slice(s,i)};var ys=(t,r,n)=>{let{input:e,sortBy:o}=u(t,r,null,n);if(l(e))return null;if(m(y(e),"$sortArray expression must resolve to an array"),j(o))return Z(N(e),o,n).value();let s=[...e];return s.sort(w),o===-1&&s.reverse(),s};var Os=(t,r,n)=>{let e=u(t,r.inputs,null,n),o=r.useLongestLength||!1;if(l(e))return null;m(y(e),"'inputs' expression must resolve to an array"),m(ft(o),"'useLongestLength' must be a boolean"),y(r.defaults)&&m(o,"'useLongestLength' must be set to true to use 'defaults'");let s=0;for(let a of e){if(l(a))return null;m(y(a),"'inputs' expression values must resolve to an array or null"),s=o?Math.max(s,a.length):Math.min(s||a.length,a.length)}let i=[],p=r.defaults||[];for(let a=0;a<s;a++){let c=e.map((f,O)=>l(f[a])?p[O]||null:f[a]);i.push(c)}return i};function Vt(t,r,n,e){m(y(r),"expression must be an array.");let o=u(t,r,null,n);return o.some(l)?null:(m(o.every(b),"expression must evalue to array of numbers."),e(o))}var As=(t,r,n)=>Vt(t,r,n,e=>e.reduce((o,s)=>o&s,-1));var bs=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(b(e),"$bitNot: expression must evaluate to a number."),~e)};var ds=(t,r,n)=>Vt(t,r,n,e=>e.reduce((o,s)=>o|s,0));var xs=(t,r,n)=>Vt(t,r,n,e=>e.reduce((o,s)=>o^s,0));var or={};lt(or,{$and:()=>An,$not:()=>bn,$or:()=>dn});var An=(t,r,n)=>{let e=u(t,r,null,n);return K(e,n.useStrictMode)&&e.every(o=>K(o,n.useStrictMode))};var bn=(t,r,n)=>{let e=et(r);return e.length==0?!1:(m(e.length==1,"Expression $not takes exactly 1 argument"),!u(t,e[0],null,n))};var dn=(t,r,n)=>{let e=u(t,r,null,n),o=n.useStrictMode;return K(e,o)&&e.some(s=>K(s,o))};var sr={};lt(sr,{$cmp:()=>xn,$eq:()=>gn,$gt:()=>hn,$gte:()=>jn,$lt:()=>En,$lte:()=>$n,$ne:()=>In});var xn=(t,r,n)=>{let e=u(t,r,null,n);return m(y(e)&&e.length==2,"$cmp: expression must resolve to array of size 2."),w(e[0],e[1])};var gn=(t,r,n)=>rt(t,r,n,nr);var hn=(t,r,n)=>rt(t,r,n,Sr);var jn=(t,r,n)=>rt(t,r,n,Cr);var En=(t,r,n)=>rt(t,r,n,Nr);var $n=(t,r,n)=>rt(t,r,n,kr);var In=(t,r,n)=>rt(t,r,n,Tr);var gs=(t,r,n)=>{let e,o,s,i="$cond: invalid arguments";y(r)?(m(r.length===3,i),e=r[0],o=r[1],s=r[2]):(m(j(r),i),e=r.if,o=r.then,s=r.else);let p=K(u(t,e,null,n),n.useStrictMode);return u(t,p?o:s,null,n)};var le=(t,r,n)=>{let e=u(t,r,null,n);return e.find(o=>!l(o))??e[e.length-1]};var hs=(t,r,n)=>{let e=null;return r.branches.some(o=>{let s=K(u(t,o.case,null,n),n.useStrictMode);return s&&(e=o.then),s}),u(t,e!==null?e:r.default,null,n)};var fe=(t,r,n)=>{m(n.scriptEnabled,"$function operator requires 'scriptEnabled' option to be true");let e=u(t,r,null,n);return e.body.apply(null,e.args)};var js=["mon","mon","tue","wed","thu","fri","sat","sun"],Es=-1e9,Wt=7,ye=t=>(t&3)==0&&(t%100!=0||t%400==0),$s=[365,366],Is=[[0,31,59,90,120,151,181,212,243,273,304,334],[0,31,60,91,121,152,182,213,244,274,305,335]],ir=t=>Is[+ye(t.getUTCFullYear())][t.getUTCMonth()]+t.getUTCDate(),Dr=(t,r)=>{let n=t.getUTCDay()||7,e=r.toLowerCase().substring(0,3);return(n-js.lastIndexOf(e)+Wt)%Wt},Tn=t=>(t+Math.floor(t/4)-Math.floor(t/100)+Math.floor(t/400))%7,wn=t=>52+ +(Tn(t)==4||Tn(t-1)==3);function Bt(t){let r=t.getUTCDay()||7,n=Math.floor((10+ir(t)-r)/7);return n<1?wn(t.getUTCFullYear()-1):n>wn(t.getUTCFullYear())?1:n}function Mr(t){return t.getUTCFullYear()-+(t.getUTCMonth()===0&&t.getUTCDate()==1&&t.getUTCDay()<1)}var jt=60,mt={week:6048e5,day:864e5,hour:36e5,minute:6e4,second:1e3,millisecond:1},Pr="%Y-%m-%dT%H:%M:%S.%LZ",Oe=[["year",0,9999],["month",1,12],["day",1,31],["hour",0,23],["minute",0,59],["second",0,59],["millisecond",0,999]];var Lt={"%b":{name:"abbr_month",padding:3,re:/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i},"%B":{name:"full_month",padding:0,re:/(January|February|March|April|May|June|July|August|September|October|November|December)/i},"%Y":{name:"year",padding:4,re:/([0-9]{4})/},"%G":{name:"year",padding:4,re:/([0-9]{4})/},"%m":{name:"month",padding:2,re:/(0[1-9]|1[012])/},"%d":{name:"day",padding:2,re:/(0[1-9]|[12][0-9]|3[01])/},"%j":{name:"day_of_year",padding:3,re:/(0[0-9][1-9]|[12][0-9]{2}|3[0-5][0-9]|36[0-6])/},"%H":{name:"hour",padding:2,re:/([01][0-9]|2[0-3])/},"%M":{name:"minute",padding:2,re:/([0-5][0-9])/},"%S":{name:"second",padding:2,re:/([0-5][0-9]|60)/},"%L":{name:"millisecond",padding:3,re:/([0-9]{3})/},"%w":{name:"day_of_week",padding:1,re:/([0-6])/},"%u":{name:"day_of_week_iso",padding:1,re:/([1-7])/},"%U":{name:"week_of_year",padding:2,re:/([1-4][0-9]?|5[0-3]?)/},"%V":{name:"week_of_year_iso",padding:2,re:/([1-4][0-9]?|5[0-3]?)/},"%z":{name:"timezone",padding:2,re:/(([+-][01][0-9]|2[0-3]):?([0-5][0-9])?)/},"%Z":{name:"minute_offset",padding:3,re:/([+-][0-9]{3})/},"%%":{name:"percent_literal",padding:1,re:/%%/}},Rr=/(%[bBYGmdjHMSLwuUVzZ%])/g,Sn=/%[bBYGmdjHMSLwuUVzZ%]/,Ts=/^[a-zA-Z_]+\/[a-zA-Z_]+$/;function it(t){if(l(t))return 0;if(Ts.test(t)){let o=new Date,s=new Date(o.toLocaleString("en-US",{timeZone:"UTC"}));return(new Date(o.toLocaleString("en-US",{timeZone:t})).getTime()-s.getTime())/6e4}let r=Lt["%z"].re.exec(t);m(!!r,`timezone '${t}' is invalid or not supported.`);let n=parseInt(r[2])||0,e=parseInt(r[3])||0;return(Math.abs(n*jt)+e)*(n<0?-1:1)}function Cn(t){return(t<0?"-":"+")+_r(Math.abs(Math.floor(t/jt)),2)+_r(Math.abs(t)%jt,2)}function at(t,r){t.setUTCMinutes(t.getUTCMinutes()+r)}function P(t,r,n){if(S(t))return t;let e=u(t,r,null,n);if(S(e))return new Date(e);if(b(e))return new Date(e*1e3);m(!!e?.date,`cannot convert ${JSON.stringify(r)} to date`);let o=S(e.date)?new Date(e.date):new Date(e.date*1e3);return e.timezone&&at(o,it(e.timezone)),o}function _r(t,r){return new Array(Math.max(r-String(t).length+1,0)).join("0")+t.toString()}var Nn=t=>{let r=t-Es;return Math.trunc(r/4)-Math.trunc(r/100)+Math.trunc(r/400)};function ws(t,r){return Math.trunc(Nn(r-1)-Nn(t-1)+(r-t)*$s[0])}var zt=(t,r)=>r.getUTCFullYear()-t.getUTCFullYear(),Ur=(t,r)=>r.getUTCMonth()-t.getUTCMonth()+zt(t,r)*12,Fr=(t,r)=>{let n=Math.trunc(t.getUTCMonth()/3);return Math.trunc(r.getUTCMonth()/3)-n+zt(t,r)*4},Qt=(t,r)=>ir(r)-ir(t)+ws(t.getUTCFullYear(),r.getUTCFullYear()),Vr=(t,r,n)=>{let e=(n||"sun").substring(0,3);return Math.trunc((Qt(t,r)+Dr(t,e)-Dr(r,e))/Wt)},vn=(t,r)=>r.getUTCHours()-t.getUTCHours()+Qt(t,r)*24,kn=(t,r)=>{let n=t.getUTCMonth()+r,e=Math.floor(n/12);if(n<0){let o=n%12+12;t.setUTCFullYear(t.getUTCFullYear()+e,o,t.getUTCDate())}else t.setUTCFullYear(t.getUTCFullYear()+e,n%12,t.getUTCDate())},Wr=(t,r,n,e)=>{let o=new Date(t);switch(r){case"year":o.setUTCFullYear(o.getUTCFullYear()+n);break;case"quarter":kn(o,3*n);break;case"month":kn(o,n);break;default:o.setTime(o.getTime()+mt[r]*n)}return o};var Nt=(t,r,n)=>{let e=u(t,r,null,n);return Wr(e.startDate,e.unit,e.amount,e.timezone)};var Ns=(t,r,n)=>{let{startDate:e,endDate:o,unit:s,timezone:i,startOfWeek:p}=u(t,r,null,n),a=new Date(e),c=new Date(o),f=it(i);switch(at(a,f),at(c,f),s){case"year":return zt(a,c);case"quarter":return Fr(a,c);case"month":return Ur(a,c);case"week":return Vr(a,c,p);case"day":return Qt(a,c);case"hour":return vn(a,c);case"minute":return a.setUTCSeconds(0),a.setUTCMilliseconds(0),c.setUTCSeconds(0),c.setUTCMilliseconds(0),Math.round((c.getTime()-a.getTime())/mt[s]);default:return Math.round((c.getTime()-a.getTime())/mt[s])}};var ks=[31,28,31,30,31,30,31,31,30,31,30,31],Ss=t=>t.month==2&&ye(t.year)?29:ks[t.month-1],Cs=(t,r,n)=>{let e=u(t,r,null,n),o=it(e.timezone);for(let s=Oe.length-1,i=0;s>=0;s--){let p=Oe[s],a=p[0],c=p[1],f=p[2],O=(e[a]||0)+i;i=0;let A=f+1;if(a=="hour"&&(O+=Math.floor(o/jt)*-1),a=="minute"&&(O+=o%jt*-1),O<c){let d=c-O;i=-1*Math.ceil(d/A),O=A-d%A}else O>f&&(O+=c,i=Math.trunc(O/A),O%=A);e[a]=O}return e.day=Math.min(e.day,Ss(e)),new Date(Date.UTC(e.year,e.month-1,e.day,e.hour,e.minute,e.second,e.millisecond))};function vs(t){return t==="Z"?0:t>="A"&&t<"N"?t.charCodeAt(0)-64:77-t.charCodeAt(0)}var Ds=t=>t.replace(/^\//,"").replace(/\/$/,""),_s=["^",".","-","*","?","$"];function Ms(t){return _s.forEach(r=>{t=t.replace(r,`\\${r}`)}),t}var Ps=(t,r,n)=>{let e=u(t,r,null,n);e.format=e.format||Pr,e.onNull=e.onNull||null;let o=e.dateString;if(l(o))return e.onNull;let s=e.format.split(Sn);s.reverse();let i=e.format.match(Rr),p={},a="";for(let A=0,d=i.length;A<d;A++){let x=i[A],g=Lt[x];if(j(g)){let E=g.re.exec(o),T=s.pop()||"";E!==null?(p[g.name]=/^\d+$/.exec(E[0])?parseInt(E[0]):E[0],o=o.substring(E.index+E[0].length+1),a+=Ms(T)+Ds(g.re.toString())):p[g.name]=null}}if(l(p.year)||l(p.month)||l(p.day)||!new RegExp("^"+a+"[A-Z]?$").exec(e.dateString))return e.onError;let c=e.dateString.match(/([A-Z])$/);m(!(c&&e.timezone),`$dateFromString: you cannot pass in a date/time string with time zone information ('${c&&c[0]}') together with a timezone argument`);let f=c?vs(c[0])*jt:it(e.timezone),O=new Date(Date.UTC(p.year,p.month-1,p.day,0,0,0));return l(p.hour)||O.setUTCHours(p.hour),l(p.minute)||O.setUTCMinutes(p.minute),l(p.second)||O.setUTCSeconds(p.second),l(p.millisecond)||O.setUTCMilliseconds(p.millisecond),at(O,-f),O};var Rs=(t,r,n)=>{let e=u(t,r?.amount,null,n);return Nt(t,{...r,amount:-1*e},n)};var Us=(t,r,n)=>{let e=u(t,r,null,n),o=new Date(e.date),s=it(e.timezone);at(o,s);let i={hour:o.getUTCHours(),minute:o.getUTCMinutes(),second:o.getUTCSeconds(),millisecond:o.getUTCMilliseconds()};return e.iso8601==!0?Object.assign(i,{isoWeekYear:Mr(o),isoWeek:Bt(o),isoDayOfWeek:o.getUTCDay()||7}):Object.assign(i,{year:o.getUTCFullYear(),month:o.getUTCMonth()+1,day:o.getUTCDate()})};var Ae=(t,r,n)=>P(t,r,n).getUTCDate();var be=(t,r,n)=>P(t,r,n).getUTCDay()+1;var de=(t,r,n)=>ir(P(t,r,n));var xe=(t,r,n)=>P(t,r,n).getUTCHours();var ge=(t,r,n)=>P(t,r,n).getUTCDay()||7;var he=(t,r,n)=>Bt(P(t,r,n));var je=(t,r,n)=>P(t,r,n).getUTCMilliseconds();var Ee=(t,r,n)=>P(t,r,n).getUTCMinutes();var $e=(t,r,n)=>P(t,r,n).getUTCMonth()+1;var Ie=(t,r,n)=>P(t,r,n).getUTCSeconds();var Te=(t,r,n)=>{let e=P(t,r,n),o=Bt(e);return e.getUTCDay()>0&&e.getUTCDate()==1&&e.getUTCMonth()==0?0:e.getUTCDay()==0?o+1:o};var Br=(t,r,n)=>P(t,r,n).getUTCFullYear();var Fs={"%Y":Br,"%G":Br,"%m":$e,"%d":Ae,"%H":xe,"%M":Ee,"%S":Ie,"%L":je,"%u":ge,"%U":Te,"%V":he,"%j":de,"%w":(t,r,n)=>be(t,r,n)-1},we=(t,r,n)=>{let e=u(t,r,null,n);if(l(e.onNull)&&(e.onNull=null),l(e.date))return e.onNull;let o=P(t,e.date,n),s=e.format||Pr,i=it(e.timezone),p=s.match(Rr);at(o,i);for(let a=0,c=p.length;a<c;a++){let f=p[a];m(f in Lt,`$dateToString: invalid format specifier ${f}`);let{name:O,padding:A}=Lt[f],d=Fs[f],x;if(d)x=_r(d(t,o,n),A);else switch(O){case"timezone":x=Cn(i);break;case"minute_offset":x=i.toString();break;case"abbr_month":case"full_month":{let g=O.startsWith("abbr")?"short":"long";x=o.toLocaleString("en-US",{month:g});break}}s=s.replace(f,x)}return s};var pr=["year","quarter","month","week","day","hour","minute","second","millisecond"];var Dn=9466848e5,_n=(t,r)=>{let n=t%r;return n<0&&(n+=r),n},Vs={day:Qt,month:Ur,quarter:Fr,year:zt},Ws=/(mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)/i,Bs=(t,r,n)=>{let{date:e,unit:o,binSize:s,timezone:i,startOfWeek:p}=u(t,r,null,n);if(l(e)||l(o))return null;let a=(p??"sun").toLowerCase().substring(0,3);m(S(e),"$dateTrunc: 'date' must resolve to a valid Date object."),m(pr.includes(o),"$dateTrunc: unit is invalid."),m(o!="week"||Ws.test(a),`$dateTrunc: startOfWeek '${a}' is not a valid.`),m(l(s)||s>0,"$dateTrunc requires 'binSize' to be greater than 0, but got value 0.");let c=s??1;switch(o){case"millisecond":case"second":case"minute":case"hour":{let f=c*mt[o],O=e.getTime()-Dn;return new Date(e.getTime()-_n(O,f))}default:{m(c<=1e11,"dateTrunc unsupported binSize value");let f=new Date(e),O=new Date(Dn),A=0;if(o=="week"){let E=Dr(O,a),T=(Wt-E)%Wt;O.setTime(O.getTime()+T*mt.day),A=Vr(O,f,a)}else A=Vs[o](O,f);let d=A-_n(A,c),x=Wr(O,o,d,i),g=it(i);return at(x,-g),x}}};var Ls=(t,r,n)=>Mr(P(t,r,n));var zs=(t,r,n)=>r;var Qs=(t,r,n)=>{let e=u(t,r.input,null,n);return ne(e,{input:"$$CURRENT"},n)};var Ks=(t,r,n)=>{let e=u(t,r,null,n),[o,s]=j(e)?[e.field,e.input||t]:[e,t];return l(s)?null:(m(j(s),"$getField expression 'input' must evaluate to an object"),m(h(o),"$getField expression 'field' must evaluate to a string"),s[o])};var qs=(t,r,n)=>Math.random();var Ys=(t,r,n)=>Math.random()<=u(t,r,null,n);var Ne=(t,r,n)=>{let e=u(t,r,null,n)??[];return oe(e,r,n)};var Hs=(t,r,n)=>{let e=u(t,r,null,n);if(l(e))return null;m(j(e),`$objectToArray requires a document input, found: ${L(e)}`);let o=Object.entries(e),s=new Array(o.length),i=0;for(let[p,a]of o)s[i++]={k:p,v:a};return s};var ke=(t,r,n)=>{let{input:e,field:o,value:s}=u(t,r,null,n);if(l(e))return null;m(j(e),"$setField expression 'input' must evaluate to an object"),m(h(o),"$setField expression 'field' must evaluate to a string");let i={...e};return r.value=="$$REMOVE"?delete i[o]:i[o]=s,i};var Gs=(t,r,n)=>ke(t,{...r,value:"$$REMOVE"},n);var Js=(t,r,n)=>{let e=u(t,r.input,null,n);return rr(e,{...r,input:"$$CURRENT"},n)};var Xs=(t,r,n)=>u(t,r,null,n)[0].every(o=>K(o,n.useStrictMode));var Zs=(t,r,n)=>u(t,r,null,n)[0].some(o=>K(o,n.useStrictMode));var ti=(t,r,n)=>{let e=u(t,r,null,n);if(l(e)||(m(y(e),"$setDifference must be an arrays."),e.some(l)))return null;m(e.length==2,"$setDifference takes exactly 2 arguments."),m(e.every(y),"$setDifference operands must be arrays.");let o=Q.init(n.hashFunction);return e[0].forEach(s=>o.set(s,!0)),e[1].forEach(s=>o.delete(s)),Array.from(o.keys())};var ri=(t,r,n)=>{let e=u(t,r,null,n);m(y(e)&&e.every(y),"$setEquals operands must be arrays.");let o=Q.init();e[0].every((s,i)=>o.set(s,i));for(let s=1;s<e.length;s++){let i=e[s],p=new Set;for(let a=0;a<i.length;a++){let c=o.get(i[a])??-1;if(c===-1)return!1;p.add(c)}if(p.size!==o.size)return!1}return!0};var ei=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:(m(y(e)&&e.every(y),"$setIntersection operands must be arrays."),Mt(e,n?.hashFunction))};var ni=(t,r,n)=>{let e=u(t,r,null,n);m(y(e)&&e.every(y),"$setIsSubset operands must be arrays.");let o=e[0],s=e[1],i=Q.init(),p=new Set;o.every((a,c)=>i.set(a,c));for(let a of s)if(p.add(i.get(a)??-1),p.size>i.size)return!0;return p.delete(-1),p.size==i.size};var oi=(t,r,n)=>{let e=u(t,r,null,n);return l(e)||(m(y(e),"$setUnion operands must be arrays."),e.some(l))?null:Pt(nt(e),n?.hashFunction)};var si=(t,r,n)=>{let e=u(t,r,null,n);return m(e.every(o=>h(o)||l(o)),"$concat only supports strings."),e.some(l)?null:e.join("")};var ii=(t,r,n)=>{let e=u(t,r,null,n),o="$indexOfBytes expression resolves to invalid an argument";if(l(e[0]))return null;m(h(e[0])&&h(e[1]),o);let s=e[0],i=e[1],p=e[2],a=e[3],c=l(p)||b(p)&&p>=0&&Math.round(p)===p;if(c=c&&(l(a)||b(a)&&a>=0&&Math.round(a)===a),m(c,o),p=p||0,a=a||s.length,p>a)return-1;let f=s.substring(p,a).indexOf(i);return f>-1?f+p:f};var pi=[0,32,9,10,11,12,13,160,5760,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202];function Kt(t,r,n,e){let o=u(t,r,null,n),s=o.input;if(l(s))return null;let i=l(o.chars)?pi:o.chars.split("").map(c=>c.codePointAt(0)),p=0,a=s.length-1;for(;e.left&&p<=a&&i.indexOf(s[p].codePointAt(0))!==-1;)p++;for(;e.right&&p<=a&&i.indexOf(s[a].codePointAt(0))!==-1;)a--;return s.substring(p,a+1)}function qt(t,r,n,e){let o=u(t,r,null,n);if(!h(o.input))return[];let s=o.options;s&&(m(s.indexOf("x")===-1,"extended capability option 'x' not supported"),m(s.indexOf("g")===-1,"global option 'g' not supported"));let i=o.input,p=new RegExp(o.regex,s),a,c=new Array,f=0;for(;a=p.exec(i);){let O={match:a[0],idx:a.index+f,captures:[]};for(let A=1;A<a.length;A++)O.captures.push(a[A]||null);if(c.push(O),!e.global)break;f=a.index+a[0].length,i=i.substring(f)}return c}var ai=(t,r,n)=>Kt(t,r,n,{left:!0,right:!1});var mi=(t,r,n)=>{let e=qt(t,r,n,{global:!1});return e&&e.length>0?e[0]:null};var ui=(t,r,n)=>qt(t,r,n,{global:!0});var ci=(t,r,n)=>qt(t,r,n,{global:!1}).length!=0;var li=(t,r,n)=>{let e=u(t,r,null,n),o=[e.input,e.find,e.replacement];return o.some(l)?null:(m(o.every(h),"$replaceAll expression fields must evaluate to string"),e.input.replace(new RegExp(e.find,"g"),e.replacement))};var fi=(t,r,n)=>{let e=u(t,r,null,n),o=[e.input,e.find,e.replacement];return o.some(l)?null:(m(o.every(h),"$replaceOne expression fields must evaluate to string"),e.input.replace(e.find,e.replacement))};var yi=(t,r,n)=>Kt(t,r,n,{left:!1,right:!0});var Oi=(t,r,n)=>{let e=u(t,r,null,n);return l(e[0])?null:(m(e.every(h),"$split expression must result to array(2) of strings"),e[0].split(e[1]))};var Ai=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1];return B(o,s)||e.every(l)?0:(m(e.every(h),"$strcasecmp must resolve to array(2) of strings"),o=o.toUpperCase(),s=s.toUpperCase(),o>s&&1||o<s&&-1||0)};var bi=(t,r,n)=>~-encodeURI(u(t,r,null,n)).split(/%..|./).length;var di=(t,r,n)=>u(t,r,null,n).length;var Se=(t,r,n)=>{let[e,o,s]=u(t,r,null,n);return o<0||!h(e)?"":s<0?e.substring(o):e.substring(o,o+s)};var xi=[192,224,240];function gi(t){if(t<128)return[t];let r=t<2048&&1||t<65536&&2||3,n=xi[r-1],e=[(t>>6*r)+n];for(;r>0;)e.push(128|t>>6*--r&63);return e}function hi(t){let r=[];for(let n=0,e=t.length;n<e;n++)r.push(gi(t.codePointAt(n)));return r}var ji=(t,r,n)=>{let e=u(t,r,null,n),o=e[0],s=e[1],i=e[2];m(h(o)&&b(s)&&s>=0&&b(i)&&i>=0,"$substrBytes: invalid arguments");let p=hi(o),a=[],c=0;for(let A=0;A<p.length;A++)a.push(c),c+=p[A].length;let f=a.indexOf(s),O=a.indexOf(s+i);return m(f>-1&&O>-1,"$substrBytes: invalid range, start or end index is a UTF-8 continuation byte."),o.substring(f,O)};var Ei=(t,r,n)=>Se(t,r,n);var $i=(t,r,n)=>{let e=u(t,r,null,n);return Y(e)?"":e.toLowerCase()};var Ii=(t,r,n)=>{let e=u(t,r,null,n);return Y(e)?"":e.toUpperCase()};var Ti=(t,r,n)=>Kt(t,r,n,{left:!0,right:!0});var wi=(t,r,n)=>tr(u(t,r,null,n),n.hashFunction);function R(t,r,n,e,o){let s={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error,...o},i=u(t,r,null,n);if(i in s){let p=s[i],a=p instanceof Error;return m(!a,`$${e.name}: value must be in range (-inf,inf)`),!a&&p}return e(i)}var Ni=(t,r,n)=>R(t,r,n,Math.acos,{Infinity:1/0,0:new Error});var ki=(t,r,n)=>R(t,r,n,Math.acosh,{Infinity:1/0,0:new Error});var Si=(t,r,n)=>R(t,r,n,Math.asin);var Ci=(t,r,n)=>R(t,r,n,Math.asinh,{Infinity:1/0,"-Infinity":-1/0});var vi=(t,r,n)=>R(t,r,n,Math.atan);var Di=(t,r,n)=>{let[e,o]=u(t,r,null,n);return isNaN(e)||l(e)?e:isNaN(o)||l(o)?o:Math.atan2(e,o)};var _i=(t,r,n)=>R(t,r,n,Math.atanh,{1:1/0,"-1":-1/0});var Mi=(t,r,n)=>R(t,r,n,Math.cos);var Pi=(t,r,n)=>R(t,r,n,Math.cosh,{"-Infinity":1/0,Infinity:1/0});var Ri=t=>t*(Math.PI/180),Ui=(t,r,n)=>R(t,r,n,Ri,{Infinity:1/0,"-Infinity":1/0});var Fi=t=>t*(180/Math.PI),Vi=(t,r,n)=>R(t,r,n,Fi,{Infinity:1/0,"-Infinity":1/0});var Wi=(t,r,n)=>R(t,r,n,Math.sin);var Bi=(t,r,n)=>R(t,r,n,Math.sinh,{"-Infinity":-1/0,Infinity:1/0});var Li=(t,r,n)=>R(t,r,n,Math.tan);var zi=(t,r,n)=>R(t,r,n,Math.tanh,{Infinity:1,"-Infinity":-1});var Ce=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:h(e)?!0:!!e};var ve=(t,r,n)=>{let e=u(t,r,null,n);if(S(e))return e;if(l(e))return null;let o=new Date(e);return m(!isNaN(o.getTime()),`cannot convert '${e}' to date`),o};var ar=(t,r,n)=>{let e=u(t,r,null,n);if(l(e))return null;if(S(e))return e.getTime();if(e===!0)return 1;if(e===!1)return 0;let o=Number(e);return m(b(o),`cannot convert '${e}' to double/decimal`),o};var mr=2147483647,Lr=-2147483648,Mn=9007199254740991,Pn=-9007199254740991;function zr(t,r,n,e,o){let s=u(t,r,null,n);if(s===!0)return 1;if(s===!1)return 0;if(l(s))return null;if(S(s))return s.getTime();let i=Number(s);return m(b(i)&&i>=e&&i<=o&&(!h(s)||i.toString().indexOf(".")===-1),`cannot convert '${s}' to ${o==mr?"int":"long"}`),Math.trunc(i)}var De=(t,r,n)=>zr(t,r,n,Lr,mr);var _e=(t,r,n)=>zr(t,r,n,Pn,Mn);var Me=(t,r,n)=>{let e=u(t,r,null,n);return l(e)?null:S(e)?we(t,{date:r,format:"%Y-%m-%dT%H:%M:%S.%LZ"},n):e.toString()};var Qi=(t,r,n)=>{let e=u(t,r,null,n);if(e.onNull=e.onNull===void 0?null:e.onNull,l(e.input))return e.onNull;try{switch(e.to){case 2:case"string":return Me(t,e.input,n);case 8:case"boolean":case"bool":return Ce(t,e.input,n);case 9:case"date":return ve(t,e.input,n);case 1:case 19:case"double":case"decimal":case"number":return ar(t,e.input,n);case 16:case"int":return De(t,e.input,n);case 18:case"long":return _e(t,e.input,n)}}catch{}return m(e.onError!==void 0,`could not convert to type ${e.to}.`),e.onError};var Ki=(t,r,n)=>{let e=u(t,r,null,n);return b(e)};var qi=ar;var Yi=(t,r,n)=>{let e=u(t,r,null,n);if(n.useStrictMode){if(e===void 0)return"missing";if(e===!0||e===!1)return"bool";if(b(e))return e%1!=0?"double":e>=Lr&&e<=mr?"int":"long";if(H(e))return"regex"}return L(e)};var Hi=(t,r,n)=>{let e={};for(let[o,s]of Object.entries(r.vars))e[o]=u(t,s,null,n);return u(t,r.in,null,I.init(n,t,{variables:e}))};var Le={};lt(Le,{$addFields:()=>kt,$bucket:()=>Gi,$bucketAuto:()=>Ji,$count:()=>ep,$densify:()=>np,$documents:()=>Re,$facet:()=>op,$fill:()=>mp,$graphLookup:()=>up,$group:()=>cr,$limit:()=>pe,$lookup:()=>We,$match:()=>Tp,$merge:()=>wp,$out:()=>Np,$project:()=>er,$redact:()=>kp,$replaceRoot:()=>Sp,$replaceWith:()=>Cp,$sample:()=>vp,$set:()=>Dp,$setWindowFields:()=>Ve,$skip:()=>ae,$sort:()=>Z,$sortByCount:()=>_p,$unionWith:()=>Mp,$unset:()=>Pp,$unwind:()=>Rp});var kt=(t,r,n)=>{let e=Object.keys(r);return e.length===0?t:t.map((o=>{let s={...o};for(let i of e){let p=u(o,r[i],null,n);p!==void 0?ht(s,i,p):It(s,i)}return s}))};var Gi=(t,r,n)=>{let e=[...r.boundaries],o=r.default,s=e[0],i=e[e.length-1],p=r.output||{count:{$sum:1}};m(e.length>1,"$bucket: must specify at least two boundaries.");let a=e.every((O,A)=>A===0||L(O)===L(e[A-1])&&w(O,e[A-1])>0);m(a,"$bucket: bounds must be of same type and in ascending order"),m(l(o)||L(o)!==L(s)||w(o,i)>=0||w(o,s)<0,"$bucket: 'default' expression must be out of boundaries range");let c=()=>{let O=new Map;for(let A=0;A<e.length-1;A++)O.set(e[A],[]);return l(o)||O.set(o,[]),t.each(A=>{let d=u(A,r.groupBy,null,n);if(l(d)||w(d,s)<0||w(d,i)>=0)m(!l(o),"$bucket require a default for out of range values"),O.get(o).push(A);else{m(w(d,s)>=0&&w(d,i)<0,"$bucket 'groupBy' expression must resolve to a value in range of boundaries");let x=Ut(e,d),g=e[Math.max(0,x-1)];O.get(g).push(A)}}),e.pop(),l(o)||(O.get(o).length?e.push(o):O.delete(o)),m(O.size===e.length,"bounds and groups must be of equal size."),N(e).map(A=>({...u(O.get(A),p,null,n),_id:A}))},f;return N(()=>(f||(f=c()),f.next()))};var Ji=(t,r,n)=>{let{buckets:e,groupBy:o,output:s,granularity:i}=r,p=s??{count:{$sum:1}};m(e>0,`$bucketAuto: 'buckets' field must be greater than 0, but found: ${e}`),i&&m(/^(POWERSOF2|1-2-5|E(6|12|24|48|96|192)|R(5|10|20|40|80))$/.test(i),`$bucketAuto: invalid granularity '${i}'.`);let a=new Map,c=i?(d,x)=>{}:(d,x)=>a.set(d,x),f=t.map(d=>{let x=u(d,o,null,n)??null;return m(!i||b(x),"$bucketAuto: groupBy values must be numeric when granularity is specified."),c(d,x??null),[x??null,d]}).value();f.sort((d,x)=>l(d[0])?-1:l(x[0])?1:w(d[0],x[0]));let O;i?i=="POWERSOF2"?O=Zi(f,e):O=rp(f,e,i):O=Xi(f,e,a);let A=!1;return N(()=>{if(A)return{done:!0};let{min:d,max:x,bucket:g,done:E}=O();A=E;let T=u(g,p,null,n);for(let[F,D]of Object.entries(T))y(D)&&(T[F]=D.filter(z=>z!==void 0));return{done:!1,value:{...T,_id:{min:d,max:x}}}})};function Xi(t,r,n){let e=t.length,o=Math.max(1,Math.round(t.length/r)),s=0,i=0;return()=>{let p=++i==r,a=new Array;for(;s<e&&(p||a.length<o||s>0&&B(t[s-1][0],t[s][0]));)a.push(t[s++][1]);let c=n.get(a[0]),f;return s<e?f=t[s][0]:f=n.get(a[a.length-1]),m(l(f)||l(c)||c<=f,"error: $bucketAuto boundary must be in order."),{min:c,max:f,bucket:a,done:s>=e}}}function Zi(t,r){let n=t.length,e=Math.max(1,Math.round(t.length/r)),o=a=>a===0?0:2**(Math.floor(Math.log2(a))+1),s=0,i=0,p=0;return()=>{let a=new Array,c=o(p);for(i=s>0?p:0;a.length<e&&s<n&&(p===0||t[s][0]<c);)a.push(t[s++][1]);for(p=p==0?o(t[s-1][0]):c;s<n&&t[s][0]<p;)a.push(t[s++][1]);return{min:i,max:p,bucket:a,done:s>=n}}}var tp={R5:[10,16,25,40,63],R10:[100,125,160,200,250,315,400,500,630,800],R20:[100,112,125,140,160,180,200,224,250,280,315,355,400,450,500,560,630,710,800,900],R40:[100,106,112,118,125,132,140,150,160,170,180,190,200,212,224,236,250,265,280,300,315,355,375,400,425,450,475,500,530,560,600,630,670,710,750,800,850,900,950],R80:[103,109,115,122,128,136,145,155,165,175,185,195,206,218,230,243,258,272,290,307,325,345,365,387,412,437,462,487,515,545,575,615,650,690,730,775,825,875,925,975],"1-2-5":[10,20,50],E6:[10,15,22,33,47,68],E12:[10,12,15,18,22,27,33,39,47,56,68,82],E24:[10,11,12,13,15,16,18,20,22,24,27,30,33,36,39,43,47,51,56,62,68,75,82,91],E48:[100,105,110,115,121,127,133,140,147,154,162,169,178,187,196,205,215,226,237,249,261,274,287,301,316,332,348,365,383,402,422,442,464,487,511,536,562,590,619,649,681,715,750,787,825,866,909,953],E96:[100,102,105,107,110,113,115,118,121,124,127,130,133,137,140,143,147,150,154,158,162,165,169,174,178,182,187,191,196,200,205,210,215,221,226,232,237,243,249,255,261,267,274,280,287,294,301,309,316,324,332,340,348,357,365,374,383,392,402,412,422,432,442,453,464,475,487,499,511,523,536,549,562,576,590,604,619,634,649,665,681,698,715,732,750,768,787,806,825,845,866,887,909,931,953,976],E192:[100,101,102,104,105,106,107,109,110,111,113,114,115,117,118,120,121,123,124,126,127,129,130,132,133,135,137,138,140,142,143,145,147,149,150,152,154,156,158,160,162,164,165,167,169,172,174,176,178,180,182,184,187,189,191,193,196,198,200,203,205,208,210,213,215,218,221,223,226,229,232,234,237,240,243,246,249,252,255,258,261,264,267,271,274,277,280,284,287,291,294,298,301,305,309,312,316,320,324,328,332,336,340,344,348,352,357,361,365,370,374,379,383,388,392,397,402,407,412,417,422,427,432,437,442,448,453,459,464,470,475,481,487,493,499,505,511,517,523,530,536,542,549,556,562,569,576,583,590,597,604,612,619,626,634,642,649,657,665,673,681,690,698,706,715,723,732,741,750,759,768,777,787,796,806,816,825,835,845,856,866,876,887,898,909,920,931,942,953,965,976,988]},Rn=(t,r)=>{if(t==0)return 0;let n=tp[r],e=n[0],o=n[n.length-1],s=1;for(;t>=o*s;)s*=10;let i=0;for(;t<e*s;)if(i=e*s,s/=10,t>=o*s)return i;m(t>=e*s&&t<o*s,"$bucketAuto: number out of range of series.");let p=Ut(n,t,(c,f)=>(f*=s,c<f?-1:c>f?1:0)),a=n[p]*s;return t==a?n[p+1]*s:a};function rp(t,r,n){let e=t.length,o=Math.max(1,Math.round(t.length/r)),s=0,i=0,p=0,a=0;return()=>{let c=++i==r,f=new Array;for(p=s>0?a:0;s<e&&(c||f.length<o);)f.push(t[s++][1]);a=Rn(t[s-1][0],n);let O=f.length;for(;s<e&&(c||t[s][0]<a);)f.push(t[s++][1]);return O!=f.length&&(a=Rn(t[s-1][0],n)),m(p<a,`$bucketAuto: ${p} < ${a}.`),{min:p,max:a,bucket:f,done:s>=e}}}var ep=(t,r,n)=>(m(h(r)&&!Y(r)&&r.indexOf(".")===-1&&r.trim()[0]!=="$","Invalid expression value for $count"),N([{[r]:t.size()}]));var np=(t,r,n)=>{let{step:e,bounds:o,unit:s}=r.range;s?(m(pr.includes(s),""),m(Number.isInteger(e)&&e>0,"The step parameter in a range statement must be a whole number when densifying a date range.")):m(b(e)&&e>0,"The step parameter in a range statement must be a strictly positive numeric value."),y(o)&&(m(!!o&&o.length===2,"A bounding array in a range statement must have exactly two elements."),m((o.every(b)||o.every(S))&&o[0]<o[1],"A bounding array must be an ascending array of either two dates or two numbers."),m(s&&!o.some(b),"Numeric bounds may not have unit parameter.")),r.partitionByFields&&m(y(r.partitionByFields),"$densify: `partitionByFields` must be an array of strings"),t=Z(t,{[r.field]:1},n);let i=I.init(n,null),p=_=>b(_)?_+e:Nt(null,{startDate:_,unit:s,amount:e},i),a=!!s&&pr.includes(s),c=_=>{let W=k(_,r.field);return m(l(W)||S(W)&&a||b(W)&&!a,"$densify: Densify field type must be numeric with 'unit' unspecified, or a date with 'unit' specified."),W},f=new Array,O=N(()=>{let _=t.next(),W=c(_.value);return l(W)?_:(f.push(_),{done:!0})}),A=Q.init(n.hashFunction),[d,x]=y(o)?o:[o,o],g,E=_=>{g=g===void 0||g<_?_:g},T=[],F=N(()=>{let _=f.length>0?f.pop():t.next();if(_.done)return _;let W=T;y(r.partitionByFields)&&(W=r.partitionByFields.map($t=>k(_.value,$t)),m(W.every(h),"$densify: Partition fields must evaluate to string values.")),m(j(_.value),"$densify: collection must contain documents");let ct=c(_.value);A.has(W)||(d=="full"?(A.has(T)||A.set(T,ct),A.set(W,A.get(T))):d=="partition"?A.set(W,ct):A.set(W,d));let q=A.get(W);if(ct<=q||x!="full"&&x!="partition"&&q>=x)return q<=ct&&A.set(W,p(q)),E(ct),_;A.set(W,p(q)),E(q);let At={[r.field]:q};return W&&W.forEach(($t,Ht)=>{At[r.partitionByFields[Ht]]=$t}),f.push(_),{done:!1,value:At}});if(d!=="full")return dt(O,F);let D=-1,z,ut=N(()=>{if(D===-1){let _=A.get(T);A.delete(T),z=Array.from(A.keys()),z.length===0&&(z.push(T),A.set(T,_)),D++}do{let _=z[D],W=A.get(_);if(W<g){A.set(_,p(W));let ct={[r.field]:W};return _.forEach((q,At)=>{ct[r.partitionByFields[At]]=q}),{done:!1,value:ct}}D++}while(D<z.length);return{done:!0}});return dt(O,F,ut)};var Re=(t,r,n)=>{let e=u(null,r,null,n);m(y(e),"$documents: expression must resolve to an array.");let o=N(e);return n.processingMode&3?o.map(G):o};var op=(t,r,n)=>t.transform((e=>{let o={};for(let[s,i]of Object.entries(r))o[s]=new pt(i,{...n,processingMode:1}).run(e);return[o]}));var ur=new WeakMap;function xt(t,r,n,e){ur.has(t)||ur.set(t,{});let o=ur.get(t);r.field in o||(o[r.field]=n());let s=!1;try{let i=e(o[r.field]);return s=!0,i}finally{s?r.documentNumber===t.length&&(delete o[r.field],Object.keys(o).length===0&&ur.delete(t)):ur.delete(t)}}function Qr(t,r,n,e,o){return xt(r,n,()=>{let s="$"+Object.keys(n.parentExpr.sortBy)[0],i=$(r,s,e),p=Rt(i,((f,O)=>i[O]),e.hashFunction),a=0,c=0;for(let f of p.keys()){let O=p.get(f).length;p.set(f,[a++,c]),c+=O}return{values:i,groups:p}},({values:s,groups:i})=>{if(i.size==r.length)return n.documentNumber;let p=s[n.documentNumber-1],[a,c]=i.get(p);return(o?a:c)+1})}var sp=(t,r,n,e,o)=>r+(o-t)*((e-r)/(n-t)),Ue=(t,r,n,e)=>xt(r,n,()=>{let o="$"+Object.keys(n.parentExpr.sortBy)[0],s=$(r,[o,n.inputExpr],e).filter((([a,c])=>b(+a)));if(s.length!==r.length)return null;let i=-1,p=0;for(;p<s.length;){for(;i+1<s.length&&b(s[i+1][1]);)i++,p=i;for(;p+1<s.length&&!b(s[p+1][1]);)p++;if(p+1>=s.length)break;for(p++;i+1<p;)s[i+1][1]=sp(s[i][0],s[i][1],s[p][0],s[p][1],s[i+1][0]),i++;i=p}return s.map(([a,c])=>c)},o=>o[n.documentNumber-1]);var Fe=(t,r,n,e)=>xt(r,n,()=>{let o=$(r,n.inputExpr,e);for(let s=1;s<o.length;s++)l(o[s])&&(o[s]=o[s-1]);return o},o=>o[n.documentNumber-1]);var Kr="_id",cr=(t,r,n)=>{m(M(r,Kr),"$group specification must include an '_id'");let e=r[Kr],o=I.init(n),s=Object.keys(r).filter(i=>i!=Kr);return t.transform((i=>{let p=Rt(i,f=>u(f,e,null,n),n.hashFunction),a=-1,c=Array.from(p.keys());return()=>{if(++a===p.size)return{done:!0};let f=c[a],O={};f!==void 0&&(O[Kr]=f);for(let A of s)O[A]=u(p.get(f),r[A],null,o.update(null,{groupId:f}));return{value:O,done:!1}}}))};var Un=new Set(["$denseRank","$documentNumber","$first","$last","$linearFill","$rank","$shift"]),ip=new Set(["$denseRank","$expMovingAvg","$linearFill","$locf","$rank","$shift"]),pp=t=>{let r=t?.documents||t?.range;return!r||r[0]==="unbounded"&&r[1]==="unbounded"},Ve=(t,r,n)=>{n=yt(n),n.context.addExpressionOps({$function:fe});for(let e of Object.values(r.output)){let o=Object.keys(e),s=o.find(J);if(m(!!st("window",s,n)||!!st("accumulator",s,n),`'${s}' is not a valid window operator`),m(o.length>0&&o.length<=2&&(o.length==1||o.includes("window")),"'output' option should have a single window operator."),e?.window){let{documents:i,range:p}=e.window;m((+!!i^+!!p)===1,"'window' option supports only one of 'documents' or 'range'.")}}return r.sortBy&&(t=Z(t,r.sortBy,n)),t=cr(t,{_id:r.partitionBy,items:{$push:"$$CURRENT"}},n),t.transform((e=>{let o=[],s=[];for(let[i,p]of Object.entries(r.output)){let a=Object.keys(p).find(J),c={operatorName:a,func:{left:st("accumulator",a,n),right:st("window",a,n)},args:p[a],field:i,window:p.window};m(!!r.sortBy||!(Un.has(a)||!c.window),`${Un.has(a)?`'${a}'`:"bounded window operation"} requires a sortBy.`),m(!c.window||!ip.has(a),`${a} does not accept a 'window' field.`),s.push(c)}return e.forEach((i=>{let p=i.items,a=N(p),c={};for(let f of s){let{func:O,args:A,field:d,window:x}=f,g=E=>{let T=-1;return F=>{if(++T,O.left)return O.left(E(F,T),A,n);if(O.right)return O.right(F,E(F,T),{parentExpr:r,inputExpr:A,documentNumber:T+1,field:d},n)}};if(x){let{documents:E,range:T,unit:F}=x,D=E||T;if(!pp(x)){let[z,ut]=D,_=q=>z=="current"?q:z=="unbounded"?0:Math.max(z+q,0),W=q=>ut=="current"?q+1:ut=="unbounded"?p.length:ut+q+1,ct=(q,At)=>{if(E||D.every(h))return p.slice(_(At),W(At));let $t=Object.keys(r.sortBy)[0],Ht,Jr;if(F){let gt=fr=>Nt(q,{startDate:new Date(q[$t]),unit:F,amount:fr},n).getTime();Ht=b(z)?gt(z):-1/0,Jr=b(ut)?gt(ut):1/0}else{let gt=q[$t];Ht=b(z)?gt+z:-1/0,Jr=b(ut)?gt+ut:1/0}let He=z=="current"?At:0,to=ut=="current"?At+1:p.length,Ge=new Array;for(;He<to;){let gt=p[He++],fr=+gt[$t];fr>=Ht&&fr<=Jr&&Ge.push(gt)}return Ge};c[d]=g(ct)}}c[d]||(c[d]=g(E=>p)),a=kt(a,{[d]:{$function:{body:E=>c[d](E),args:["$$CURRENT"]}}},n)}o.push(a)})),dt(...o)}))};var ap={locf:"$locf",linear:"$linearFill"},mp=(t,r,n)=>{m(!r.sortBy||j(r.sortBy),"sortBy must be an object."),m(!!r.sortBy||Object.values(r.output).every(i=>M(i,"value")),"sortBy required if any output field specifies a 'method'."),m(!(r.partitionBy&&r.partitionByFields),"specify either partitionBy or partitionByFields."),m(!r.partitionByFields||r?.partitionByFields?.every(i=>i[0]!=="$"),"fields in partitionByFields cannot begin with '$'."),n=yt(n),n.context.addExpressionOps({$ifNull:le}),n.context.addWindowOps({$locf:Fe,$linearFill:Ue});let e=r.partitionBy||r?.partitionByFields?.map(i=>"$"+i),o={},s={};for(let[i,p]of Object.entries(r.output))if(M(p,"value"))o[i]={$ifNull:[`$$CURRENT.${i}`,p.value]};else{let a=ap[p.method];m(!!a,`invalid fill method '${p.method}'.`),s[i]={[a]:"$"+i}}return Object.keys(s).length>0&&(t=Ve(t,{sortBy:r.sortBy||{},partitionBy:e,output:s},n)),Object.keys(o).length>0&&(t=kt(t,o,n)),t};function qr(t,r){let n=!!t&&t[0]?.$documents;return n?{documents:Re(null,n,r).value(),pipeline:t.slice(1)}:{pipeline:t}}var We=(t,r,n)=>{let e=h(r.from)?n?.collectionResolver(r.from):r.from,{let:o,foreignField:s,localField:i}=r,p=A=>[!0,[]],{documents:a,pipeline:c}=qr(r.pipeline??[],n);if(m(!e!=!a,"$lookup: must specify single join input with `expr.from` or `expr.pipeline`."),e=e??a,m(y(e),"$lookup: join collection must resolve to an array."),s&&i){let A=Q.init(n.hashFunction);for(let d of e)et(k(d,s)??null).forEach(x=>{let g=A.get(x),E=g??[];E.push(d),E!==g&&A.set(x,E)});if(p=d=>{let x=k(d,i)??null;if(y(x)){if(c.length)return[x.some(T=>A.has(T)),null];let E=Array.from(new Set(nt(x.map(T=>A.get(T),n.hashFunction))));return[E.length>0,E]}let g=A.get(x)??null;return[g!==null,g??[]]},c.length===0)return t.map(d=>({...d,[r.as]:p(d).pop()}))}let f=new pt(c,n),O={...n};return t.map(A=>{let d=u(A,o,null,n);O.variables={...n.variables,...d};let[x,g]=p(A);return{...A,[r.as]:x?f.run(e,O):g}})};var up=(t,r,n)=>{let e=h(r.from)?n?.collectionResolver(r.from):r.from,{connectFromField:o,connectToField:s,as:i,maxDepth:p,depthField:a,restrictSearchWithMatch:c}=r,f=c?{pipeline:[{$match:c}]}:{};return t.map(O=>{let A={};ht(A,o,u(O,r.startWith,null,n));let d=[A],x=-1,g=Q.init(n.hashFunction);do{x++,d=nt(We(N(d),{from:e,localField:o,foreignField:s,as:i,...f},n).map(D=>D[i]).value());let F=g.size;if(d.forEach(D=>g.set(D,g.get(D)??x)),F==g.size)break}while(l(p)||x<p);let E=new Array(g.size),T=0;return g.forEach((F,D)=>{E[T++]=Object.assign(a?{[a]:F}:{},D)}),{...O,[i]:E}})};var lr={};lt(lr,{$elemMatch:()=>cp,$slice:()=>lp});var cp=(t,r,n,e)=>{let o=k(t,n),s=new X(r,e);m(y(o),"$elemMatch: argument must resolve to array");let i=[];for(let p=0;p<o.length;p++)if(s.test(o[p])){if(e.useStrictMode)return[o[p]];i.push(o[p])}return i.length>0?i:void 0};var lp=(t,r,n,e)=>{let o=k(t,n),s=r;return y(o)?ce(t,y(r)?[o,...s]:[o,r],e):o};var St={};lt(St,{$all:()=>fp,$and:()=>Ep,$bitsAllClear:()=>Fn,$bitsAllSet:()=>Vn,$bitsAnyClear:()=>Wn,$bitsAnySet:()=>Bn,$elemMatch:()=>yp,$eq:()=>Ln,$exists:()=>Ap,$expr:()=>dp,$gt:()=>zn,$gte:()=>Qn,$in:()=>Kn,$jsonSchema:()=>xp,$lt:()=>qn,$lte:()=>Yn,$mod:()=>gp,$ne:()=>Hn,$nin:()=>Gn,$nor:()=>$p,$not:()=>Ip,$or:()=>Be,$regex:()=>hp,$size:()=>Op,$type:()=>bp,$where:()=>jp});var fp=(t,r,n)=>C(t,r,n,fn);var yp=(t,r,n)=>C(t,r,n,ue);var Op=(t,r,n)=>C(t,r,n,yn);var Et=(t,r,n)=>C(t,r,null,(e,o)=>{let s=0;if(y(o))for(let i of o)s=s|1<<i;else s=o;return n(e&s,s)});var Fn=(t,r,n)=>Et(t,r,(e,o)=>e==0);var Vn=(t,r,n)=>Et(t,r,(e,o)=>e==o);var Wn=(t,r,n)=>Et(t,r,(e,o)=>e<o);var Bn=(t,r,n)=>Et(t,r,(e,o)=>e>0);var Ln=(t,r,n)=>C(t,r,n,nr);var zn=(t,r,n)=>C(t,r,n,Sr);var Qn=(t,r,n)=>C(t,r,n,Cr);var Kn=(t,r,n)=>C(t,r,n,me);var qn=(t,r,n)=>C(t,r,n,Nr);var Yn=(t,r,n)=>C(t,r,n,kr);var Hn=(t,r,n)=>C(t,r,n,Tr);var Gn=(t,r,n)=>C(t,r,n,wr);var Ap=(t,r,n)=>{let e=t.includes("."),o=!!r;return!e||t.match(/\.\d+$/)?s=>k(s,t)!==void 0===o:s=>{let i=bt(s,t,{preserveIndex:!0}),p=k(i,t.substring(0,t.lastIndexOf(".")));return y(p)?p.some(a=>a!==void 0)===o:p!==void 0===o}};var bp=(t,r,n)=>C(t,r,n,On);function dp(t,r,n){return e=>u(e,r,null,n)}function xp(t,r,n){m(!!n?.jsonSchemaValidator,"$jsonSchema: must configure 'jsonSchemaValidator' option to this operator.");let e=n?.jsonSchemaValidator(r);return o=>e(o)}var gp=(t,r,n)=>C(t,r,n,cn);var hp=(t,r,n)=>C(t,r,n,ln);function jp(t,r,n){m(n.scriptEnabled,"$where: 'scriptEnabled' option must be true");let e=r;return m(Zt(e),"$where only accepts a Function object"),o=>K(e.call(o),n?.useStrictMode)}var Ep=(t,r,n)=>{m(y(r),"Invalid expression: $and expects value to be an Array.");let e=r.map(o=>new X(o,n));return o=>e.every(s=>s.test(o))};var Be=(t,r,n)=>{m(y(r),"Invalid expression. $or expects value to be an Array");let e=r.map(o=>new X(o,n));return o=>e.some(s=>s.test(o))};var $p=(t,r,n)=>{m(y(r),"Invalid expression. $nor expects value to be an array.");let e=Be("$or",r,n);return o=>!e(o)};var Ip=(t,r,n)=>{let e={};e[t]=Or(r);let o=new X(e,n);return s=>!o.test(s)};var Ot=class extends X{constructor(r,n){let e=yt(n);e.context.addExpressionOps(or).addExpressionOps(sr).addProjectionOps(lr).addQueryOps(St),super(r,e)}};var Tp=(t,r,n)=>{let e=new Ot(r,n);return t.filter(o=>e.test(o))};var wp=(t,r,n)=>{let e=h(r.into)?n?.collectionResolver(r.into):r.into;m(y(e),"$merge: option 'into' must resolve to an array");let o=r.on||n.idKey,s=h(o)?a=>tr(k(a,o),n.hashFunction):a=>tr(o.map(c=>k(a,c),n.hashFunction)),i=Q.init();for(let a=0;a<e.length;a++){let c=e[a],f=s(c);m(!i.has(f),"$merge: 'into' collection must have unique entries for the 'on' field."),i.set(f,[c,a])}let p=I.init(n);return t.map(a=>{let c=s(a);if(i.has(c)){let[f,O]=i.get(c),A=u(f,r.let||{new:"$$ROOT"},null,p.update(a));if(y(r.whenMatched)){let d=new pt(r.whenMatched,{...n,variables:A});e[O]=d.run([f])[0]}else switch(r.whenMatched){case"replace":e[O]=a;break;case"fail":throw new Dt("$merge: failed due to matching as specified by 'whenMatched' option.");case"keepExisting":break;case"merge":default:e[O]=Ne(f,[f,a],p.update(a,{variables:A}));break}}else switch(r.whenNotMatched){case"discard":break;case"fail":throw new Dt("$merge: failed due to matching as specified by 'whenMatched' option.");case"insert":default:e.push(a);break}return a})};var Np=(t,r,n)=>{let e=h(r)?n?.collectionResolver(r):r;return m(y(e),"expression must resolve to an array"),t.map(o=>(e.push(G(o)),o))};var kp=(t,r,n)=>{let e=I.init(n);return t.map(o=>br(o,r,e.update(o)))};var Sp=(t,r,n)=>t.map(e=>(e=u(e,r.newRoot,null,n),m(j(e),"$replaceRoot expression must return an object"),e));var Cp=(t,r,n)=>t.map(e=>(e=u(e,r,null,n),m(j(e),"$replaceWith expression must return an object"),e));var vp=(t,r,n)=>t.transform(e=>{let o=e.length,s=-1;return()=>{if(++s===r.size)return{done:!0};let i=Math.floor(Math.random()*o);return{value:e[i],done:!1}}});var Dp=kt;var _p=(t,r,n)=>Z(cr(t,{_id:r,count:{$sum:1}},n),{count:-1},n);var Mp=(t,r,n)=>{let{coll:e,pipeline:o}=h(r)||y(r)?{coll:r}:r,s=h(e)?n.collectionResolver(e):e,{documents:i,pipeline:p}=qr(o??[],n);m(!s!=!i,"$unionWith: must specify single collection input with `expr.coll` or `expr.pipeline`.");let a=s??i;return dt(t,p?new pt(p,n).stream(a):N(a))};var Pp=(t,r,n)=>{r=et(r);let e={};for(let o of r)e[o]=0;return er(t,e,n)};var Rp=(t,r,n)=>{h(r)&&(r={path:r});let o=r.path.substring(1),s=r?.includeArrayIndex||!1,i=r.preserveNullAndEmptyArrays||!1,p=(c,f)=>(s!==!1&&(c[s]=f),c),a;return N(()=>{for(;;){if(a instanceof Ft){let O=a.next();if(!O.done)return O}let c=t.next();if(c.done)return c;let f=c.value;if(a=k(f,o),y(a)){if(a.length===0&&i===!0)return a=null,It(f,o),{value:p(f,null),done:!1};a=N(a).map(((O,A)=>{let d=bt(f,o,{preserveKeys:!0});return ht(d,o,O),p(d,A)}))}else if(!Y(a)||i===!0)return{value:p(f,null),done:!1}}})};var ze={};lt(ze,{$denseRank:()=>Up,$derivative:()=>Fp,$documentNumber:()=>Vp,$expMovingAvg:()=>Wp,$integral:()=>Bp,$linearFill:()=>Ue,$locf:()=>Fe,$minMaxScaler:()=>Lp,$rank:()=>zp,$shift:()=>Qp});var Up=(t,r,n,e)=>Qr(t,r,n,e,!0);var Fp=(t,r,n,e)=>{if(r.length<2)return null;let{input:o,unit:s}=n.inputExpr,i="$"+Object.keys(n.parentExpr.sortBy)[0],p=[r[0],r[r.length-1]],a=$(p,[i,o],e).filter((([x,g])=>b(+x)&&b(+g)));if(a.length!==2)return null;let[[c,f],[O,A]]=a,d=(O-c)/(mt[s]||1);return(A-f)/d};var Vp=(t,r,n,e)=>n.documentNumber;var Wp=(t,r,n,e)=>{let{input:o,N:s,alpha:i}=n.inputExpr;return m(!(s&&i),"You must specify either N or alpha. You cannot specify both."),xt(r,n,()=>{let p=$(r,o,e).filter(b);return p.length===r.length?p:null},p=>{if(p===null)return null;if(n.documentNumber==1)return p[0];let a=s!=null?2/(s+1):i,c=n.documentNumber-1;return p[c]=p[c]*a+p[c-1]*(1-a),p[c]})};var Bp=(t,r,n,e)=>{let{input:o,unit:s}=n.inputExpr,i="$"+Object.keys(n.parentExpr.sortBy)[0],p=$(r,[i,o],e).filter((([f,O])=>b(+f)&&b(+O)));if(p.length!==r.length)return null;let a=0,c=r.length;for(let f=1;f<c;f++){let[O,A]=p[f-1],[d,x]=p[f],g=(d-O)/(mt[s]||1);a+=.5*(A+x)*g}return a};var Lp=(t,r,n,e)=>xt(r,n,()=>{let o=n.inputExpr,s=o.min||0,i=o.max||1,p=$(r,o.input||n.inputExpr,e);m(y(p)&&p.length>0&&p.every(b),"$minMaxScaler: input must be a numeric array");let a=p[0],c=p[0];for(let A of p)A<a?a=A:A>c&&(c=A);let f=i-s,O=c-a;return m(O!==0,"$minMaxScaler: input range must not be zero"),{min:s,scale:f,rmin:a,range:O,nums:p}},o=>{let{min:s,rmin:i,scale:p,range:a,nums:c}=o;return(c[n.documentNumber-1]-i)/a*p+s});var zp=(t,r,n,e)=>Qr(t,r,n,e,!1);var Qp=(t,r,n,e)=>{let o=n.inputExpr,s=n.documentNumber-1+o.by;return s<0||s>r.length-1?o.default?u(t,o.default,null,e):null:u(r[s],o.output,null,e)};var Jn=()=>tt.init().addAccumulatorOps(ie).addExpressionOps(Pe).addPipelineOps(Le).addProjectionOps(lr).addQueryOps(St).addWindowOps(ze);var Yr={};lt(Yr,{$addToSet:()=>qp,$bit:()=>Hp,$currentDate:()=>Gp,$inc:()=>Jp,$max:()=>Xp,$min:()=>Zp,$mul:()=>ta,$pop:()=>ra,$pull:()=>Qe,$pullAll:()=>ea,$push:()=>oa,$rename:()=>sa,$set:()=>Ke,$unset:()=>ia});var v={cloneMode:"copy",queryOptions:yt({context:tt.init().addQueryOps(St).addExpressionOps(or).addExpressionOps(sr)})},Yt=(t,r)=>{switch(t){case"deep":return G(r);case"copy":return S(r)?new Date(r):y(r)?[...r]:j(r)?{...r}:H(r)?new RegExp(r):r;default:return r}},Kp=/^[a-z]+[a-zA-Z0-9]*$/;function Xn(t){if(!t.includes(".$"))return[{parent:t,selector:t},[]];let r=t.indexOf(".$"),n=t.indexOf("]"),e=t.substring(0,r),o=t.substring(r+3,n);m(o===""||Kp.test(o),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");let s=t.substring(n+2),[i,p]=s?Xn(s):[];return[{selector:t,parent:e,child:o||"$",next:i},[o,...p||[]].filter(Boolean)]}var U=(t,r,n,e,o)=>{let{parent:s,child:i,next:p}=r;if(!i){let c=!1;return _t(t,s,(O,A)=>c=!!e(O,A)||c,o),c}let a=k(t,s);return y(a)?a.map((c,f)=>n[i]&&!n[i].test({[i]:c})?!1:p?U(c,p,n,e,o):e(a,f)).some(Boolean):!1};function V(t,r,n,e){let o=[];for(let[s,i]of Object.entries(t)){let[p,a]=Xn(s);if(!a.length)e(i,p,{})&&o.push(p.parent);else{let c={};r.forEach(O=>{Object.keys(O).forEach(A=>{a.forEach(d=>{(A===d||A.startsWith(d+"."))&&(c[d]=c[d]||{},Object.assign(c[d],{[A]:O[A]}))})})});let f={};for(let[O,A]of Object.entries(c))f[O]=new Ot(A,n.queryOptions);e(i,p,f)&&o.push(p.parent)}}return o}var qp=(t,r,n=[],e=v)=>V(r,n,e,(o,s,i)=>{let p={$each:[o]};return j(o)&&M(o,"$each")&&Object.assign(p,o),U(t,s,i,(a,c)=>{let f=a[c]||=[];return Mt([f,p.$each]).length===p.$each.length?!1:(a[c]=Yt(e.cloneMode,Pt(f.concat(p.$each))),!0)},{buildGraph:!0})});var Yp=new Set(["and","or","xor"]),Hp=(t,r,n=[],e=v)=>V(r,n,e,((o,s,i)=>{let p=Object.keys(o);return m(p.length===1&&Yp.has(p[0]),`Invalid bit operator '${p[0]}'. Must be one of 'and', 'or', or 'xor'.`),U(t,s,i,(a,c)=>{let f=a[c],O=o[p[0]];if(f!==void 0&&!(b(f)&&b(O)))return!1;switch(f=f||0,p[0]){case"and":a[c]=f&O;break;case"or":a[c]=f|O;break;case"xor":a[c]=f^O;break}return a[c]!==f},{buildGraph:!0})}));var Gp=(t,r,n=[],e=v)=>{let o=Date.now();return V(r,n,e,((s,i,p)=>U(t,i,p,(a,c)=>(a[c]=o,!0),{buildGraph:!0})))};var Jp=(t,r,n=[],e=v)=>V(r,n,e,(o,s,i)=>{if(!s.child){let p=k(t,s.parent);m(p===void 0||b(p),"cannot apply $inc to a value of non-numeric type")}return U(t,s,i,(p,a)=>(p[a]=(p[a]||=0)+o,!0),{buildGraph:!0})});var Xp=(t,r,n=[],e=v)=>V(r,n,e,((o,s,i)=>U(t,s,i,(p,a)=>p[a]!==void 0&&w(p[a],o)>-1?!1:(p[a]=o,!0),{buildGraph:!0})));var Zp=(t,r,n=[],e=v)=>V(r,n,e,((o,s,i)=>U(t,s,i,(p,a)=>p[a]!==void 0&&w(p[a],o)<1?!1:(p[a]=o,!0),{buildGraph:!0})));var ta=(t,r,n=[],e=v)=>V(r,n,e,((o,s,i)=>U(t,s,i,(p,a)=>{let c=p[a];return p[a]=p[a]===void 0?0:p[a]*o,p[a]!==c},{buildGraph:!0})));var ra=(t,r,n=[],e=v)=>V(r,n,e,((o,s,i)=>U(t,s,i,(p,a)=>{let c=p[a];return m(y(c),`path '${s.selector}' contains an element of non-array type.`),c.length?(o===-1?c.splice(0,1):c.pop(),!0):!1})));var Qe=(t,r,n=[],e=v)=>V(r,n,e,((o,s,i)=>{let p=!j(o)||Object.keys(o).some(J),a=new Ot(p?{k:o}:o,e.queryOptions),c=p?f=>a.test({k:f}):f=>a.test(f);return U(t,s,i,(f,O)=>{let A=f[O],d=new Array;return A.map(g=>{let E=c(g);return E||d.push(g),E}).some(Boolean)?(f[O]=d,!0):!1})}));var ea=(t,r,n=[],e=v)=>{let o={};return Object.entries(r).forEach(([s,i])=>{o[s]={$in:i}}),Qe(t,o,n,e)};var na=["$each","$slice","$sort","$position"],oa=(t,r,n=[],e=v)=>V(r,n,e,((o,s,i)=>{let p={$each:[o]};return j(o)&&na.some(a=>M(o,a))&&Object.assign(p,o),U(t,s,i,(a,c)=>{let f=a[c]||=[],O=f.slice(0,p.$slice||f.length),A=f.length,d=b(p.$position)?p.$position:f.length;if(f.splice(d,0,...Yt(e.cloneMode,p.$each)),p.$sort){let x=j(p.$sort)?Object.keys(p.$sort||{}).pop():"",g=x?p.$sort[x]:p.$sort,E=x?T=>k(T,x):T=>T;f.sort((T,F)=>g*w(E(T),E(F)))}return b(p.$slice)&&(p.$slice<0?f.splice(0,f.length+p.$slice):f.splice(p.$slice)),A!=f.length||!B(O,f)},{descendArray:!0,buildGraph:!0})}));var Ke=(t,r,n=[],e=v)=>V(r,n,e,(o,s,i)=>U(t,s,i,(p,a)=>B(p[a],o)?!1:(p[a]=Yt(e.cloneMode,o),!0),{buildGraph:!0}));var sa=(t,r,n=[],e=v)=>{let o=[],s=V(r,n,e,((i,p,a)=>U(t,p,a,(c,f)=>M(c,f)?(o.push(...Ke(t,{[i]:c[f]},n,e)),delete c[f],!0):!1)));return Array.from(new Set(s.concat(o)))};var ia=(t,r,n=[],e=v)=>V(r,n,e,(o,s,i)=>U(t,s,i,(p,a)=>M(p,a)?(y(p)?p[a]=null:delete p[a],!0):!1));function qe(t){return t=t??v,(r,n,e=[],o={},s=t)=>{let i=Object.entries(n);m(i.length===1,"Update expression must contain only one operator.");let[p,a]=i[0];m(M(Yr,p),`Update operator '${p}' is not supported.`);let c=Yr[p];return Object.keys(o).length&&!new Ot(o,s.queryOptions).test(r)?[]:c(r,a,e,s)}}var iS=qe();var pa=Jn(),Ye=t=>{let r=yt(t);return{...r,context:tt.merge(pa,r.context)}},Hr=class extends X{constructor(r,n){super(r,Ye(n))}},Gr=class extends pt{constructor(r,n){super(r,Ye(n))}},Zn=t=>qe({...t,queryOptions:Ye(t?.queryOptions)}),aa=Zn(),ma=(t,r,n)=>new Gr(r,n).run(t),ua=(t,r,n,e)=>new Hr(r,e).find(t,n);return so(ca);})();
